# Docker Compose for Jetson PCM Receiver (RTP Input Unit)
#
# Receives RTP audio stream from Raspberry Pi 5 and outputs to ALSA Loopback.
#
# ⚠️ IMPORTANT: snd-aloop (ALSA Loopback) setup required on Jetson host BEFORE running.
#
# Execute on Jetson host (ONCE ONLY):
#   sudo ./scripts/setup_snd_aloop.sh
#
# Verify:
#   lsmod | grep snd_aloop
#   arecord -l | grep Loopback
#
# For detailed setup instructions, see:
#   docs/setup/jetson_snd_aloop.md

services:
  jetson-pcm-receiver:
    image: jetson-pcm-receiver:latest
    build:
      context: ../..
      dockerfile: docker/jetson_pcm_receiver/Dockerfile.jetson
    container_name: jetson-pcm-receiver
    restart: always
    runtime: nvidia

    # ⚠️ Audio device access (requires snd-aloop loaded on host)
    devices:
      - /dev/snd:/dev/snd

    # Add to audio group for ALSA device access
    group_add:
      - audio
    ports:
      - "46001:46001/tcp"
    environment:
      # 必要に応じて上書き（CLI引数と同等）
      # JPR_PORT: "46001"
      JPR_DEVICE: "hw:Loopback,0,0"
      # JPR_LOG_LEVEL: "warn"
      # JPR_CONNECTION_MODE: "single"
      # JPR_PRIORITY_CLIENTS: "10.0.0.1,10.0.0.2"
      # JPR_DISABLE_ZMQ: "false"
      # JPR_ZMQ_ENDPOINT: "ipc:///tmp/jetson_pcm_receiver.sock"
      # JPR_ZMQ_PUB_INTERVAL_MS: "1000"
    healthcheck:
      test: ["CMD", "pgrep", "jetson-pcm-receiver"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
