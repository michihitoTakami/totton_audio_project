# Docker Compose for Magic Box - Local x86_64 development/testing
#
# Usage:
#   cd docker
#   docker compose -f docker-compose.local.yml up -d --build
#

services:
  # ========================================================================== 
  # Audio Processing Daemon (Data Plane)
  # ========================================================================== 
  audio-daemon:
    image: magicbox-local:latest
    build:
      context: ..
      dockerfile: docker/Dockerfile.jetson
      args:
        BASE_IMAGE_DEVEL: nvidia/cuda:12.6.2-devel-ubuntu22.04
        BASE_IMAGE_RUNTIME: nvidia/cuda:12.6.2-runtime-ubuntu22.04
    container_name: magicbox-audio-local
    command: daemon
    restart: unless-stopped
    runtime: nvidia
    environment:
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=compute,utility
    devices:
      - /dev/snd:/dev/snd
    shm_size: '256m'
    volumes:
      - zmq-socket:/tmp
    cap_add:
      - SYS_NICE
    healthcheck:
      test: ["CMD", "pgrep", "-f", "gpu_upsampler_alsa"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

  # ========================================================================== 
  # Web UI (Control Plane)
  # ========================================================================== 
  web-ui:
    image: magicbox-local:latest
    container_name: magicbox-web-local
    command: web
    restart: unless-stopped
    depends_on:
      audio-daemon:
        condition: service_healthy
    ports:
      - "80:80"
    volumes:
      - zmq-socket:/tmp
    environment:
      - ZMQ_ENDPOINT=ipc:///tmp/gpu_os.sock
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost/status"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

volumes:
  zmq-socket:
