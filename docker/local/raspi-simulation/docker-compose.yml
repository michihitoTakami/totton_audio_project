# Docker Compose for RasPi RTP Sender (Development/Testing)
#
# このファイルは現在のPCをRasPiに見立てて、PipeWireのRTPストリームを
# Magic Boxに中継するテスト環境を構築します。
#
# 構成:
#   [PC PipeWire] → RTP (224.0.0.56:46000)
#   ↓ (このコンテナが受信)
#   [rtp-sender] → REST API経由でSDP送信 + RTP転送
#   ↓
#   [Magic Box] RtpSessionManager
#
# Usage:
#   cd docker/local/raspi-simulation
#   docker compose up -d --build
#
# 前提条件:
#   - PCのPipeWireが224.0.0.56:46000にRTP送信している
#   - Magic BoxがREST APIで待機している
#   - オーディオフォーマット設定がPipeWire設定と一致していること
#

services:
  # ==========================================================================
  # RTP Sender (RasPi役割)
  # ==========================================================================
  rtp-sender:
    image: raspi-rtp-sender:latest
    build:
      context: ../../..
      dockerfile: docker/raspi/Dockerfile.rtp-sender
    container_name: raspi-rtp-sender
    restart: unless-stopped
    network_mode: host  # ホストネットワークを使用してマルチキャスト受信
    environment:
      # 受信設定（PC PipeWireから）
      - RTP_RECV_MULTICAST_GROUP=224.0.0.56
      - RTP_RECV_PORT=46000

      # 送信設定（Magic Boxへ）
      - MAGIC_BOX_HOST=192.168.1.10  # Magic BoxのIPアドレス（要変更）
      - MAGIC_BOX_API_PORT=8000
      - RTP_SEND_PORT=46001

      # オーディオフォーマット設定
      # ⚠️ PipeWireのrtp-sink.conf設定と一致させること！
      - RTP_SAMPLE_RATE=44100    # audio.rate と一致
      - RTP_CHANNELS=2           # audio.channels と一致
      - RTP_BITS_PER_SAMPLE=16   # format: S16=16, S24=24, S32=32
      - RTP_PAYLOAD_TYPE=127     # 動的ペイロードタイプ

      # セッションID
      - RTP_SESSION_ID=raspi-uac2

      # ログレベル
      - LOG_LEVEL=INFO
    volumes:
      - ./logs/rtp-sender:/var/log/rtp-sender
    healthcheck:
      test: ["CMD", "pgrep", "-f", "rtp_sender"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 5s
