# Docker Compose for Totton Audio Project - Jetson (runtime-only / image-based)
#
# Issue: #1058
#
# 目的:
# - 評価者がソースコード不要で `image:` 参照だけで起動できる構成。
# - 既存の `docker-compose.jetson.yml`（ローカルビルド前提）を壊さない。
#
# Usage:
#   cd docker
#   docker compose -f jetson/docker-compose.jetson.runtime.yml up -d
#

services:
  Totton Audio Project:
    # Runtime-only distribution (GHCR)
    # 評価時は release note 掲載の digest で pin することを推奨。
    # 例: TOTTON_AUDIO_IMAGE=ghcr.io/michihitotakami/totton-audio-system@sha256:<digest>
    image: ${TOTTON_AUDIO_IMAGE:-ghcr.io/michihitotakami/totton-audio-system:latest}
    platform: linux/arm64
    container_name: totton_audio
    command: all
    restart: always

    runtime: nvidia

    devices:
      - /dev/snd:/dev/snd

    # 既存 compose と同等の挙動（互換）: 80 + RTP/RTCP UDP を公開
    ports:
      # デフォルトは USB gadget のみ（Jetson: 192.168.55.1）に公開して、
      # Wi-Fi/有線LAN等への意図しない露出を避ける。
      # LANで公開したい場合は明示的に変更する（インターネット公開は禁止/非推奨）。
      # 例（LANで公開）:
      #   TOTTON_AUDIO_PUBLISH_IP=0.0.0.0 docker compose -f jetson/docker-compose.jetson.runtime.yml up -d
      - "${TOTTON_AUDIO_PUBLISH_IP:-192.168.55.1}:80:80"
      - "${TOTTON_AUDIO_PUBLISH_IP:-192.168.55.1}:46000:46000/udp"
      - "${TOTTON_AUDIO_PUBLISH_IP:-192.168.55.1}:46001:46001/udp"
      - "${TOTTON_AUDIO_PUBLISH_IP:-192.168.55.1}:46002:46002/udp"

    shm_size: '256m'

    # 永続化（評価者の再起動/更新でも維持したいもの）
    volumes:
      - Totton Audio Project-config:/opt/totton_audio/config
      - Totton Audio Project-opra-cache:/data/opra

    environment:
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=compute,utility
      - TOTTON_AUDIO_PROFILE=jetson
      - GPU_OS_DATA_DIR=/data
      - TOTTON_AUDIO_ENABLE_RTP=false
      - TOTTON_AUDIO_RTP_AUTOSTART=false
      - TOTTON_AUDIO_RTP_SENDER_HOST=192.168.55.100
      - RTP_BRIDGE_ENDPOINT=tcp://192.168.55.100:60000
      - TOTTON_AUDIO_PI_API_BASE=${TOTTON_AUDIO_PI_API_BASE:-http://192.168.55.100:8081}
      - TOTTON_AUDIO_WAIT_AUDIO_SECS=8
      - TOTTON_AUDIO_WAIT_LOOPBACK=true

    cap_add:
      - SYS_NICE

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

volumes:
  Totton Audio Project-config:
  Totton Audio Project-opra-cache:
