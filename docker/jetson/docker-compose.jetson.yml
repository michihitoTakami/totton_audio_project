# Docker Compose for Magic Box - Jetson Orin Nano Super
#
# Production deployment configuration.
#
# Usage:
#   cd docker
#   # Runtime-only (no build). Pull from GHCR and run.
#   docker compose -f jetson/docker-compose.jetson.yml up -d
#
#   # LAN公開が必要な場合（明示）:
#   docker compose -f jetson/docker-compose.jetson.yml -f jetson/docker-compose.jetson.lan.yml up -d
#
# Logs:
#   docker compose -f jetson/docker-compose.jetson.yml logs -f
#
# Stop:
#   docker compose -f jetson/docker-compose.jetson.yml down
#

services:
  # ==========================================================================
  # Magic Box (Audio Daemon + Web UI in single container)
  # ==========================================================================
  magicbox:
    # Runtime-only distribution (Issue #1058):
    # - 評価者はソース不要で `docker pull` して起動できること。
    # - 既定は GHCR の image を参照（必要なら MAGICBOX_IMAGE で差し替え）。
    image: ${MAGICBOX_IMAGE:-ghcr.io/michihitotakami/totton-audio-system:latest}
    container_name: magicbox
    command: all
    restart: always

    # NVIDIA runtime for GPU access
    runtime: nvidia

    # Audio device access
    devices:
      - /dev/snd:/dev/snd

    # Web UI
    # セキュアデフォルト:
    # - LAN前提の運用でも、公開が不要な環境（USB直結/単体運用）を想定し、
    #   既定は localhost バインドにする（Issue #1058 / Epic #1051）。
    # - LAN公開が必要な場合は `jetson/docker-compose.jetson.lan.yml` を重ねる。
    ports:
      - "${MAGICBOX_BIND_ADDR:-127.0.0.1}:80:80"

    # Shared memory for audio buffers
    shm_size: '256m'

    # 永続化方針（Issue #1058）:
    # - 設定: named volume (`magicbox-config`) を /opt/magicbox/config へ
    # - OPRAキャッシュ: named volume (`magicbox-opra-cache`) を /data/opra へ
    # - 係数/デフォルトEQ: image 同梱（ホストマウントしない）
    volumes:
      # Persist runtime config outside the image (survives rebuilds)
      - magicbox-config:/opt/magicbox/config
      # Persist OPRA sync cache outside the image
      - magicbox-opra-cache:/data/opra

    # Environment (NVIDIA)
    environment:
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=compute,utility
      - MAGICBOX_PROFILE=jetson
      # Data root for OPRA cache (mounted as a volume)
      - GPU_OS_DATA_DIR=/data
      # RTP はコードとして残すが、I2Sメイン運用ではデフォルトで無効化する。
      # 必要な場合のみ MAGICBOX_ENABLE_RTP=true にし、必要ならポートも公開する。
      - MAGICBOX_ENABLE_RTP=false
      - MAGICBOX_RTP_AUTOSTART=false
      # USB直結構成では mDNS(raspberrypi.local) が見えないことがあるため、IPで固定
      - MAGICBOX_RTP_SENDER_HOST=192.168.55.100
      # ZeroMQ ブリッジを使う場合（任意）
      - RTP_BRIDGE_ENDPOINT=tcp://192.168.55.100:60000
      # Pi control API (USB-I2S bridge)
      # Pi の USB(gadget) 側IPは 192.168.55.100 を前提（mDNS が見えない構成でも到達できるよう固定）。
      - MAGICBOX_PI_API_BASE=${MAGICBOX_PI_API_BASE:-http://192.168.55.100:8081}
      # Wait for ALSA devices to appear after cold boot
      - MAGICBOX_WAIT_AUDIO_SECS=8
      - MAGICBOX_WAIT_LOOPBACK=true
      # Set MAGICBOX_RESET_CONFIG=true to restore default config on next start
      # - MAGICBOX_RTP_RTCP_SEND_ENABLED=0
      # - MAGICBOX_RTP_USE_RTPBIN=0

    # Real-time priority (requires CAP_SYS_NICE)
    cap_add:
      - SYS_NICE

    # Health check (temporarily disabled for debugging)
    # healthcheck:
    #   test: ["CMD", "pgrep", "-f", "gpu_upsampler_alsa"]
    #   interval: 10s
    #   timeout: 5s
    #   retries: 3
    #   start_period: 10s

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"


volumes:
  magicbox-config:
  magicbox-opra-cache:
