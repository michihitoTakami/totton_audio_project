# Docker Compose for Magic Box - Jetson Orin Nano Super
#
# Production deployment configuration.
#
# ⚠️ IMPORTANT: snd-aloop (ALSA Loopback) setup required on Jetson host BEFORE running this compose file.
#
# Execute on Jetson host (ONCE ONLY):
#   sudo ./scripts/setup_snd_aloop.sh
#
# Verify:
#   lsmod | grep snd_aloop
#   arecord -l | grep Loopback
#
# For detailed setup instructions, see:
#   docs/setup/jetson_snd_aloop.md
#
# Usage:
#   cd docker
#   docker compose -f jetson/docker-compose.jetson.yml up -d --build
#
# Logs:
#   docker compose -f jetson/docker-compose.jetson.yml logs -f
#
# Stop:
#   docker compose -f jetson/docker-compose.jetson.yml down
#

services:
  # ==========================================================================
  # Magic Box (Audio Daemon + Web UI in single container)
  # ==========================================================================
  magicbox:
    image: magicbox:latest
    build:
      context: ../..
      dockerfile: docker/jetson/Dockerfile.jetson
    container_name: magicbox
    command: all
    restart: always

    # NVIDIA runtime for GPU access
    runtime: nvidia

    # ⚠️ Audio device access (requires snd-aloop loaded on host)
    # snd-aloop MUST be loaded on Jetson host before container starts:
    #   sudo modprobe snd_aloop
    # or use:
    #   sudo ./scripts/setup_snd_aloop.sh
    devices:
      - /dev/snd:/dev/snd

    # Add to audio group for ALSA device access
    group_add:
      - audio

    # Web UI + RTP受信 (UDP 46000, RTCP 46001/46002)
    ports:
      - "46000:46000/udp"
      - "46001:46001/udp"
      - "46002:46002/udp"
      - "80:80"

    # Shared memory for audio buffers
    shm_size: '256m'

    # Mount data directory (EQ profiles, coefficients, OPRA database)
    # Static data (coefficients, OPRA database) is read-only for protection
    # EQ profiles directory is writable for dynamic profile generation
    volumes:
      - ../../data:/opt/magicbox/data:ro
      - ../../data/EQ:/opt/magicbox/data/EQ:rw
      # Persist runtime config outside the image (survives rebuilds)
      - magicbox-config:/opt/magicbox/config

    # Environment (NVIDIA)
    environment:
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=compute,utility
      - MAGICBOX_RTP_AUTOSTART=true
      # USB直結構成では mDNS(raspberrypi.local) が見えないことがあるため、IPで固定
      - MAGICBOX_RTP_SENDER_HOST=192.168.55.100
      # ZeroMQ ブリッジを使う場合（任意）
      - RTP_BRIDGE_ENDPOINT=tcp://192.168.55.100:60000
      # Wait for ALSA devices to appear after cold boot
      - MAGICBOX_WAIT_AUDIO_SECS=8
      - MAGICBOX_WAIT_LOOPBACK=true
      # Set MAGICBOX_RESET_CONFIG=true to restore default config on next start
      # - MAGICBOX_RTP_RTCP_SEND_ENABLED=0
      # - MAGICBOX_RTP_USE_RTPBIN=0

    # Real-time priority (requires CAP_SYS_NICE)
    cap_add:
      - SYS_NICE

    # Health check (temporarily disabled for debugging)
    # healthcheck:
    #   test: ["CMD", "pgrep", "-f", "gpu_upsampler_alsa"]
    #   interval: 10s
    #   timeout: 5s
    #   retries: 3
    #   start_period: 10s

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"


volumes:
  magicbox-config:
