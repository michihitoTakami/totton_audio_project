# セルフレビュー: Issue #266 フィルタ切り替え時のソフトミュート実装

## 実装概要
フィルタ係数の切り替え時（サンプリングレート変更、EQプロファイル変更、フェーズタイプ切り替え、クロスフィード切り替え）に約3秒間のソフトミュートを適用する機能を実装。

## 発見された問題点

### 🔴 重大な問題

#### 1. スレッドセーフティの問題
**場所**: `src/alsa_daemon.cpp:applySoftMuteForFilterSwitch()`, `src/pipewire_daemon.cpp:handle_rate_change()`

**問題**:
- `setFadeDuration()`と`setSampleRate()`はスレッドセーフではない（`soft_mute.h`のコメント参照）
- オーディオ処理スレッドが`process()`を呼んでいる間に、これらのパラメータを変更すると競合する可能性がある
- `fadeSamples_`の再計算が`updateFadeSamples()`で行われるが、`process()`中に変更されると不整合が発生する可能性

**影響**: オーディオ処理中のクラッシュや音声の不具合

**修正案**:
```cpp
// オーディオ処理スレッドを一時停止するか、フェードパラメータの変更を同期する
// または、フェード時間を変更する前にオーディオ処理を一時停止する仕組みを追加
```

#### 2. ブロッキングの問題
**場所**: `src/alsa_daemon.cpp:applySoftMuteForFilterSwitch()`, `src/pipewire_daemon.cpp:handle_rate_change()`

**問題**:
- `applySoftMuteForFilterSwitch()`は1.5秒間ブロックする可能性がある
- ZeroMQコマンド処理スレッドがブロックされ、他のコマンドが処理できなくなる
- PipeWireのメインループがブロックされ、イベント処理が遅延する

**影響**: デーモンの応答性の低下、タイムアウトエラーの可能性

**修正案**:
- 非同期処理に変更するか、フェードアウト完了を待たずにフィルタ切り替えを実行
- または、フェードアウト完了をオーディオ処理スレッドで検知する仕組みを追加

### 🟡 中程度の問題

#### 3. フェード時間のリセットタイミング
**場所**: `src/alsa_daemon.cpp:applySoftMuteForFilterSwitch()`, `src/alsa_daemon.cpp:1237`

**問題**:
- `originalFadeDuration`を保存しているが、成功時にリセットしていない
- オーディオ処理スレッドでリセットするが、タイミングが不確実
- フェードイン完了を検知する方法が不確実（`getState() == PLAYING`でチェックしているが、フェード時間が1500msのままの場合がある）

**影響**: 次回のフィルタ切り替え時にフェード時間が正しく設定されない可能性

**修正案**:
```cpp
// フェードイン完了時にフェード時間をリセットするフラグを追加
// または、フェード時間を変更する際に、元の値を保存して確実にリセットする
```

#### 4. pipewire_daemon.cppでのフェード時間リセット
**場所**: `src/pipewire_daemon.cpp:218`

**問題**:
- `pipewire_daemon.cpp`でもフェード時間のリセット処理があるが、`originalFadeDuration`を保存していない
- デフォルト値（50ms）をハードコードしている

**影響**: 初期化時に異なるフェード時間が設定されている場合、正しくリセットされない

**修正案**:
- `originalFadeDuration`を保存してリセットする

#### 5. エラーハンドリングの不備
**場所**: `src/alsa_daemon.cpp:applySoftMuteForFilterSwitch()`

**問題**:
- フェードアウト中にフィルタ切り替えが失敗した場合、フェードインを開始しない
- しかし、フェードアウト完了後の状態（MUTED）がそのまま残る可能性がある

**影響**: 音声がミュート状態のままになる

**修正案**:
```cpp
if (!switch_success) {
    // フェードアウトをキャンセルして元の状態に戻す
    g_soft_mute->setPlaying();
    g_soft_mute->setFadeDuration(originalFadeDuration);
}
```

### 🟢 軽微な問題

#### 6. ログメッセージの一貫性
**場所**: 複数箇所

**問題**:
- ログメッセージのフォーマットが統一されていない
- `[Rate]`, `[Filter Switch]`など、異なるプレフィックスが使用されている

**影響**: ログの可読性の低下

**修正案**:
- ログメッセージのフォーマットを統一

#### 7. マジックナンバー
**場所**: `src/alsa_daemon.cpp:141`, `src/pipewire_daemon.cpp:111`

**問題**:
- `FILTER_SWITCH_FADE_MS = 1500`が複数箇所で定義されている
- デフォルトのフェード時間（50ms）もマジックナンバー

**影響**: メンテナンス性の低下

**修正案**:
- 定数を`daemon_constants.h`に定義

#### 8. タイムアウト値の妥当性
**場所**: `src/alsa_daemon.cpp:167`, `src/pipewire_daemon.cpp:130`

**問題**:
- フェードアウトのタイムアウトが2秒に設定されているが、フェード時間が1.5秒なので、タイムアウトが発生する可能性が低い
- しかし、オーディオ処理が停止している場合、タイムアウトが発生する可能性がある

**影響**: タイムアウトの妥当性が不明確

**修正案**:
- タイムアウト値をフェード時間の1.5倍程度に設定するか、コメントで説明を追加

## 推奨される修正

### 優先度: 高

1. **スレッドセーフティの改善**
   - オーディオ処理スレッドを一時停止する仕組みを追加
   - または、フェードパラメータの変更を同期する

2. **ブロッキングの解消**
   - 非同期処理に変更するか、フェードアウト完了を待たずにフィルタ切り替えを実行

3. **フェード時間のリセットの確実化**
   - フェードイン完了時に確実にフェード時間をリセットする仕組みを追加

### 優先度: 中

4. **エラーハンドリングの改善**
   - フィルタ切り替え失敗時の状態復元を確実にする

5. **定数の定義**
   - マジックナンバーを定数として定義

### 優先度: 低

6. **ログメッセージの統一**
   - ログフォーマットの統一

7. **ドキュメンテーションの追加**
   - スレッドセーフティモデルの説明を追加

## テストの網羅性

### ✅ カバーされている項目
- 基本的なフェードアウト/フェードインの動作
- 1500msフェードの完了
- フェード時間の変更とリセット

### ⚠️ 不足している項目
- スレッドセーフティのテスト（並行アクセスのテスト）
- ブロッキング動作のテスト
- エラー時の状態復元のテスト
- オーディオ処理スレッドとの競合のテスト

## 結論

実装は基本的な機能要件を満たしているが、スレッドセーフティとブロッキングの問題が重大な懸念事項として残っている。これらの問題を修正することを強く推奨する。

