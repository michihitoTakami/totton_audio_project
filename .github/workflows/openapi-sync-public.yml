name: Sync OpenAPI to public repo (optional)

on:
  release:
    types: [published]
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: openapi-sync-public
  cancel-in-progress: false

jobs:
  sync:
    runs-on: ubuntu-latest
    env:
      TARGET_REPO: michihitoTakami/totton-audio-system-full
      TARGET_BRANCH: main
      EXPORT_DIR: /tmp/openapi_export
      CLONE_DIR: /tmp/public_repo
      TOKEN: ${{ secrets.PUBLIC_REPO_TOKEN }}
    steps:
      - name: Validate secret (skip if missing)
        run: |
          set -euo pipefail
          if [ -z "${TOKEN}" ]; then
            echo "secrets.PUBLIC_REPO_TOKEN is not configured. Skipping."
            exit 0
          fi

      - name: Checkout private repo
        if: env.TOKEN != ''
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup uv
        if: env.TOKEN != ''
        uses: astral-sh/setup-uv@v3
        with:
          python-version-file: ".python-version"
          enable-cache: true

      - name: Install Python deps
        if: env.TOKEN != ''
        run: |
          set -euo pipefail
          uv sync --frozen

      - name: Export OpenAPI JSONs (for sync)
        if: env.TOKEN != ''
        run: |
          set -euo pipefail
          mkdir -p "${EXPORT_DIR}"
          uv run python scripts/integration/export_openapi.py --output "${EXPORT_DIR}/openapi.json"
          uv run python scripts/integration/export_raspi_openapi.py --output "${EXPORT_DIR}/raspi_openapi.json"

      - name: Clone public repo
        if: env.TOKEN != ''
        run: |
          set -euo pipefail
          clone_url="https://x-access-token:${TOKEN}@github.com/${TARGET_REPO}.git"
          git clone --depth=1 "${clone_url}" "${CLONE_DIR}"

      - name: Create branch and sync files
        if: env.TOKEN != ''
        env:
          GH_TOKEN: ${{ env.TOKEN }}
        run: |
          set -euo pipefail

          target_owner="$(echo "${TARGET_REPO}" | cut -d/ -f1)"
          target_name="$(echo "${TARGET_REPO}" | cut -d/ -f2)"

          cd "${CLONE_DIR}"
          git switch -c "sync/openapi-${GITHUB_REF_NAME:-manual}-${GITHUB_SHA:0:7}"

          mkdir -p docs/api
          cp -f "${EXPORT_DIR}/openapi.json" docs/api/openapi.json
          cp -f "${EXPORT_DIR}/raspi_openapi.json" docs/api/raspi_openapi.json

          git add -A
          if git diff --cached --quiet; then
            echo "OpenAPIに差分なし。"
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git commit -m "Sync OpenAPI from michy_os@${GITHUB_SHA}"
          git push -u origin HEAD

          head_ref="${target_owner}:$(git branch --show-current)"

          existing_pr_count="$(
            gh api \
              "repos/${target_owner}/${target_name}/pulls?state=open&base=${TARGET_BRANCH}&head=${head_ref}" \
              | jq 'length'
          )"

          if [ "${existing_pr_count}" != "0" ]; then
            echo "既存のOpenなPRがあるため作成をスキップ: head=${head_ref}"
            exit 0
          fi

          gh api -X POST "repos/${target_owner}/${target_name}/pulls" \
            -f title="Sync OpenAPI from michy_os@${GITHUB_SHA:0:7}" \
            -f head="${head_ref}" \
            -f base="${TARGET_BRANCH}" \
            -f body="Automated sync from private repo.\n\nSource: ${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/commit/${GITHUB_SHA}\nTrigger: ${GITHUB_EVENT_NAME}"
