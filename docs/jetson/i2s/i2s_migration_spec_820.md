# I2S移行 仕様（Issue #820）

## 目的
I2S移行（Pi5 → Jetson）における前提・仕様を確定し、**実装がブレない**ようにする。最優先は **安定性（無音断・無ポップ・無XRUN）**、次に **音質（クリップ回避・ジッタ/ノイズ耐性・既存DSP品質の維持）**。

## スコープ
- Pi5 が **I2S送信（master/TX）**、Jetson が **I2S受信（slave/RX）**
- I2S入力のサンプルレート変化（44.1k系⇄48k系）を、停止→再初期化→フェードで安全に切り替える
- 44.1k系/48k系 × 1/2/4/8/16（最大 768k）に対する **必須/推奨/任意** と **フォールバック方針** を定義する
- e2e遅延の測定方法と成功基準を定義する

（本ドキュメントは実装ではなく仕様。実装Issue/PRは本仕様を参照すること。）

---

## 前提（安定・音質優先の設計思想）
- **配線は10cmのメスメスジャンパー**を基本とする（信号品質の限界がある）
- 高速クロック線を増やすほど不安定化しやすい（リンギング/クロストーク/EMI）
- よって、I2S入力は可能な限り **低いBCLK**（=低いFs/スロット幅固定）で運用し、アップサンプル等の重処理はJetson側で完結させる

---

## I2S信号仕様

### 方向・役割
- **方向**: Pi5(TX, master) → Jetson(RX, slave)
- **クロック**: Pi5がBCLK/LRCLKを供給し、Jetsonはそれに同期してサンプルする

### 信号線
- **必須**: `BCLK` / `LRCLK` / `DATA` / `GND`
- **MCLK**: **使用しない（MVPでは禁止）**
  - 理由: 10cmジャンパー前提で、追加の高速クロック線は不安定化要因が大きい。さらに 768k 運用ではBCLK自体が高周波になり、MCLKまで足すメリットよりリスクが大きい。
  - 将来（別途Issue）で、専用ケーブル/レベル変換/終端を含むハード要件が揃った場合のみ再検討。

### 電気仕様（必須要件）
- **ロジック電圧**: 送受信双方のI2Sピンが同一電圧であること（原則 3.3V）。
  - Jetson Orin Nano DevKitのJ12（40pin）上のI2S0系信号は 3.3V として扱う（Carrier Board Specificationの記載に従う）。
  - もし実機が 1.8V で動作している/疑いがある場合: **レベルシフタ必須**（片方向でも可）。
- **GND**: できれば `GND` を追加で1本（計2本）取り、`BCLK` 近傍のGNDを優先する（可能な範囲で）。
- **配線**: ジャンパー線はできるだけ平行に束ねず、BCLK/LRCLKはGNDの近くを走らせる。
- **終端（推奨）**: 発振側（Pi側）の `BCLK/LRCLK/DATA` に 22–47Ω の直列抵抗（リンギングが出る場合）。

---

## 配線（pin-to-pin）

### 重要（結論）
- **BCLK/LRCLK** は **Pi5 40pinヘッダ** と **Jetson Orin Nano DevKit J12（40pin）** で同じ物理ピン番号に配置されている。
- **DATAはTX/RX（DOUT/DIN）の向き**の都合で、MVP（Pi→Jetson）では **クロス配線**が必要（PiのDOUT → JetsonのDIN）。
- **MCLK（pin 7）はMVPでは使わない**。

### 配線表（MVP / Pi → Jetson）
| 接続 | Pi5 物理ピン | Pi5 GPIO（代表） | Jetson J12 物理ピン | Jetson信号名（代表） | 備考 |
|---|---:|---|---:|---|---|
| BCLK | 12 | GPIO18 | 12 | I2S0_SCLK | クロック（最優先で配線品質確保） |
| LRCLK | 35 | GPIO19 | 35 | I2S0_FS | フレーム同期 |
| DATA（Pi DOUT → Jetson DIN） | 40 | GPIO21（DOUT） | 38 | I2S0_DIN | **クロス配線** |
| GND | 39 | - | 39 | - | DATAの隣（推奨） |

#### 任意（品質向上）
- 追加GND（例）: 34（LRCLK隣）, 14（BCLK近傍）

### 使わない線（MVPでは禁止）
| 信号 | Pi5 物理ピン | Jetson J12 物理ピン | 理由 |
|---|---:|---:|---|
| MCLK | 7 | 7 | ジャンパー前提では不安定化要因が増える（MVPでは禁止） |
| Pi DIN | 38 | 38 | MVPはPi→Jetsonの片方向（PiのDINは未使用） |
| Jetson DOUT | 40 | 40 | JetsonはRX運用のため未使用 |

### 配線の指針（信号品質）
- **長さ**: まずは **10cm以下**。
- **GND本数**: 最低1本（pin 39）。可能なら **2本（pin 39 + pin 34）**。
- **引き回し**:
  - BCLK/LRCLKは可能なら **GNDとペア**（例: BCLK(12)↔GND(14), LRCLK(35)↔GND(34)）。
  - BCLKはデータ線から離す（クロストーク低減）。
- **直列抵抗（推奨・発振側=Pi側）**:
  - まずは **33Ω** を候補（22–47Ωの範囲で調整）。
  - 対象: BCLK/LRCLK（必要ならDATAも）。

### Jetson側の注意（ピンマルチプレクス）
- J12のピンは用途切替（pinmux）が必要な場合があるため、Jetson側は **Jetson-IO** 等でI2S0が有効になっていることを前提とする。

---

## 推奨ケーブル/部材

### 最低限案（MVP）
- 10cm メスメスジャンパー（Dupont）×4（BCLK/LRCLK/DATA/GND）
- 可能なら GND追加で +1（計5本）

### 品質優先案（推奨）
- **ツイスト/ペア**相当の配線（手作業で軽く撚るでも可）
  - BCLK-GND / LRCLK-GND / DATA-GND
- Pi側直近に **22–47Ω直列抵抗**（BCLK/LRCLK優先）
- 物理固定（抜け/接触不良対策）
  - ジャンパーの抜け止め、ホットボンド、結束バンド等

---

## 電源/グランド設計
- **推奨**: Pi5とJetsonはそれぞれの電源で給電し、**信号用のGNDは必ず共通化**する（I2Sの基準電位が揃わないと不安定化する）。
- **禁止**: GPIO経由で相手を給電しない（電流/保護/ノイズ/事故の観点でNG）。
- **配線**:
  - 電源線とI2S信号線は物理的に離す。
  - GNDは可能なら太め/短め（または複数本）で電位差を減らす。

---

## データフォーマット仕様

### I2Sプロトコル
- **方式**: Philips I2S（標準I2S、MSBがLRCLKエッジの1bit後）
- **チャンネル**: 2ch（Stereo）
- **LRCLK極性**: `LRCLK=0` を Left、`LRCLK=1` を Right（原則）

### ビット深度・スロット幅
- **スロット幅**: 32bit 固定
- **有効ビット**:
  - **必須（推奨運用）**: 24-bit in 32-bit slot（いわゆる 24in32）
  - **任意**: 32-bit（将来/検証後）
- **符号**: 2’s complement signed

（理由: 3バイト詰め（S24_3LE）を避け、実装・DMA・アライメントを単純化して安定性を上げる）

---

## サンプルレート（レートマトリクス）

### 入力（I2S, Pi→Jetson）
- **必須**: 44,100 Hz / 48,000 Hz
- **任意（将来/検証後）**: 88,200 Hz / 96,000 Hz
- **非対応（MVP）**: 176.4k/192k 以上（ジャンパー配線前提でBCLKが上がり過ぎ、安定性が落ちる）

> 参考: 32bit×2ch（64fs）なら BCLK = Fs × 64
> - 48k → 3.072MHz（安定しやすい）
> - 96k → 6.144MHz（要検証）

### 出力（Jetson→DAC等）
本プロジェクトの品質目標に合わせ、Jetson側で **倍率（ratio）= 1/2/4/8/16** を選択できることを仕様とする。
- 出力レート: `Fs_out = Fs_in × ratio`

| Fs_in | ratio | Fs_out | 位置づけ |
|---:|---:|---:|---|
| 44.1k | 16 | 705.6k | **推奨（最優先ターゲット）** |
| 48k | 16 | 768k | **推奨（最優先ターゲット）** |
| 44.1k | 8 | 352.8k | **必須フォールバック** |
| 48k | 8 | 384k | **必須フォールバック** |
| 44.1k | 4 | 176.4k | 任意フォールバック |
| 48k | 4 | 192k | 任意フォールバック |
| 44.1k | 2 | 88.2k | 最終フォールバック |
| 48k | 2 | 96k | 最終フォールバック |
| 44.1k | 1 | 44.1k | 緊急バイパス |
| 48k | 1 | 48k | 緊急バイパス |

---

## 768kが成立しない場合のフォールバック方針（受入条件の必須項目）

### フォールバックのトリガ
以下のいずれかを満たしたら **音質より連続再生**を優先して段階的に倍率を落とす。
- **出力デバイスのオープン失敗**（指定 `Fs_out` で ALSA hw_params が通らない）
- **XRUNが継続**（例: 10秒間にXRUNが1回以上、または5分で3回以上）
- **バッファアンダーフローが継続**（内部メトリクスで `RenderedSilence` が増える）
- **GPUフォールバックが有効化**（品質低下状態）

### フォールバックの順序
- `ratio: 16 → 8 → 4 → 2 → 1`
- 入力が 44.1k系/48k系のどちらであっても **同じ順序**で降格する
- 降格後は、明示的な手動操作または再起動があるまで **自動昇格しない**（不安定な「行ったり来たり」を防ぐ）

---

## レート切替（検知→停止→再初期化→フェード/ミュート→再開）

### 状態機械（仕様）
- **PLAYING**: 通常再生
- **FADING_OUT**: 出力をフェードアウト（ポップ回避）
- **RECONFIG**: 入出力・DSPを停止/再初期化
- **FADING_IN**: フェードインして復帰
- **ERROR_FALLBACK**: 失敗時に倍率降格して再試行

### 切替手順（規定シーケンス）
1. **切替検知**: `Fs_in` 変化（44.1k系⇄48k系）または `ratio` 変更要求を受ける
2. **入力停止**: I2Sキャプチャ（または入力取り込み）を一時停止/ドロップ開始
3. **フェードアウト**: 既存の `SoftMute` 相当で出力を0へ（目標: 50ms、最大でも200ms以内に“ほぼ無音”）
4. **バッファ破棄**: 内部キュー/ストリーミング状態をクリア（不連続混入を防ぐ）
5. **DSP再初期化**:
   - 入力レートを切替
   - 係数/フィルタ（44.1k系/48k系）を再選択
   - headroomメタデータを再読み込み（クリップ防止）
6. **出力再初期化**:
   - `Fs_out` に合わせてALSAデバイスを再オープン/再設定
7. **フェードイン**: 0→1へ復帰
8. **入力再開**: I2Sキャプチャ再開

### 失敗時の規定
- 5 or 6 が失敗した場合:
  - 可能なら **直前の安定設定へロールバック**
  - ロールバック不可なら **ERROR_FALLBACK** に遷移し、倍率を1段落として再試行
  - それでも不可なら **緊急バイパス（ratio=1）** を試し、最終的に「ミュート維持＋エラー通知」

---

## e2e遅延：測定方法 / 成功基準

### 測定方法（推奨）
- Pi側でテスト刺激（インパルス/スイープ）を作り、I2SでJetsonへ供給
- Jetson側で最終出力を録音し、相関またはインパルス位置から遅延を算出

例（既存ドキュメント/スクリプト流用）:
- `docs/investigations/low_latency_partition_validation.md` の手順をベースに、
  - 入力を「I2S」へ置き換え
  - 出力を `pw-record` もしくは `arecord` でキャプチャ

### 成功基準（受入）
- **安定性**:
  - 連続10分再生で XRUN = 0
  - 切替時に可聴なポップ/クリックがない（少なくとも -60dB 以上のクリックが連発しない）
- **音質/安全**:
  - クリップカウンタが増えない（headroom運用が効いている）
  - 係数/分割畳み込みの品質検証が `low_latency_partition_validation.md` の基準を満たす
- **遅延（目標）**:
  - 低遅延パーティションの fast window が 705.6k/768k において **<10–12ms**（既存目標と整合）
  - e2e遅延の揺らぎ（同一条件での再測定の分散）が **±1ms以内**

---

## 実装時の注意（仕様としての拘束）
- 切替は必ず **フェードアウト→再初期化→フェードイン** を挟む（無音断の方がポップよりマシ）
- I2S入力は可能な限り **44.1k/48kのまま**Jetsonへ渡す（10cmジャンパー前提の安定策）
- 768k達成は「最優先ターゲット」だが、成立しない環境では **自動的に降格**して連続再生を守る

---

## 関連ドキュメント
- 運用手順（Runbook）: `docs/jetson/i2s/ops_runbook.md`（Issue #827）

---

## 変更履歴
- 2025-12-15: 初版（Issue #820 の仕様ドラフト）
- 2025-12-15: Issue #821（配線/信号品質/電源・GND設計）を追記
