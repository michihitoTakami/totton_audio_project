# 640kタップ広帯域FIRとHRTF短タップの2段構成案

## 背景 / ゴール
- 640k級の広帯域補正フィルタ（最小位相）と、HRTFクロスフィード（~16k–32kタップ程度）の処理負荷・レイテンシ要求が異なるため、単一レーンでの処理は過剰負荷やノイズ源になりうる。
- 広帯域補正パスとHRTFパスを2段構成で分離し、GPU/ALSA設定を最適化した設計指針を示す。
- 本ドキュメントは設計確定と実装タスク列挙が目的であり、実装は別Issueで行う。

## 提案するシグナルフロー（2段）
```
            ┌──────────────┐
PCM in ───► │ Stage A: Wide FIR (≥640k, 最小位相) │ ──► (ステレオ)
            │  - アップサンプリング/広帯域補正       │
            │  - 2ch (L/R)                           │
            └──────────────┘
                       │705.6k/768k float32 (ステレオ)
                       ▼
            ┌──────────────┐
            │ Stage B: HRTF/Crossfeed (≤32k) │ ──► Out_L/Out_R
            │  - 4ch FIR (LL, LR, RL, RR)    │
            │  - 短タップ・別CUDAストリーム  │
            └──────────────┘
```
- Stage AとBを別CUDAストリーム＋ダブルバッファで接続し、長大FIRの実行時間がHRTFパスをブロックしないようにする。
- ALSA/PipeWireの入出力バッファは両ステージで共有するが、内部バッファはステージ毎に分離（リングバッファ）してスケジューリングを平滑化。

## 推奨パラメータ（初期値）
| 項目 | Stage A: 広帯域FIR | Stage B: HRTF |
|------|-------------------|---------------|
| タップ数 | 最大 640k（既存係数） | 16k デフォルト（最大32k想定） |
| ブロックサイズ (L) | 16384 (約23.2ms@705.6k) ※計算負荷とスループット優先 | 8192 (約11.6ms@705.6k) 低レイテンシ優先 |
| FFTサイズ (N = next_pow2(L+M-1)) | 1,048,576 (640k + 16k -1) | 32,768 (16k + 8k -1) |
| FFT複素数 (N/2+1) | 524,289 | 16,385 |
| CUDAストリーム | stream_fir (高優先度) | stream_hrtf (高優先度) |
| 係数配置 | ステレオ2ch（L, R） | 4ch（LL, LR, RL, RR） |
| データ型 | float32 | float32 |

### メモリ概算（オーバーラップセーブ, float32, 1ステレオ分）
- Stage A (N=1,048,576):
  - 入力パッド/出力: 約 1,048,576 * 4B * 2 ≈ 8.4 MB
  - 周波数バッファ（complex）: 524,289 * 8B * 3 (inL,inR,out) ≈ 12.6 MB
  - フィルタFFT（2ch）: 524,289 * 8B * 2 ≈ 8.4 MB
  - オーバーラップ/ワーク領域などを含めても ~40–50 MB 程度/ステレオで収まる見込み。
- Stage B (N=32,768):
  - 入出力/周波数/フィルタを含めても数MB以下（GPU圧迫要素にならない）。

### レイテンシの考え方
- アルゴリズム遅延はオーバーラップセーブの性質上 (M-1) が理論上の最大だが、Stage Aの広帯域FIRは最小位相でエネルギーを前方集中させており知覚遅延は主にブロックサイズとバッファ遅延で決まる。
- 実効遅延目安: Stage Aブロック23ms + Stage Bブロック12ms + ALSA I/Oバッファ（例: 2〜3×16ms）でおおむね <70ms を目標。
- さらなる低遅延が必要な場合は Stage A をパーティション分割（例: 64kパーティション×10）するハイブリッド畳み込みを別Issueで検討。

## ALSA / PipeWire バッファリング指針
- ALSA: 705.6k/768k 出力時に `period_size = 8192`, `buffer_size = period_size * 4` を目安（約43–45ms）。Stage A/Bのブロックと整合性を取る。
- PipeWire: RTP/USB入力のジッタを吸収するため、上流バッファは最小1 period多めに取る（例: 10–15ms相当）。
- ダブルバッファ or 小リングバッファで Stage A->B を接続し、CUDAストリーム間の待ち合わせを最小化。

## 追加で必要なコード変更（別Issue化する項目）
- [ ] Stage A/B を別コンテキスト・別CUDAストリームで駆動する実装（現在の単一レーンを分離）。
- [ ] Stage間バッファ（host→device）のダブルバッファリングとイベント同期の導入。
- [ ] ALSA設定: 705.6k/768k 時の `period_size` / `buffer_size` をStageブロックと整合させる自動提案ロジック。
- [ ] パーティション畳み込み対応（大タップを複数FFTに分割）オプションを追加し、計測スイッチで選択可能にする。
- [ ] モニタリング: CUDAイベントによる per-stage 実行時間・オーバーラン検出の統計をZMQ経由で取得するフック。
- [ ] テスト: GPUなしCI向けに Stage A/B のFFTサイズ・タップ数一致、メタデータ整合をチェックするユニットテストを追加。

## まとめ
- 広帯域FIRとHRTFを2段に分け、ストリーム/バッファを分離することで、長大フィルタによるスパイクや高域ノイズのリスクを低減しつつ、短タップHRTFで低遅延を維持する設計を推奨する。
- 本ドキュメントは設計合意用。実装は別Issueで進める（上記チェックリスト参照）。
