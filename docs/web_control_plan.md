# Webベースの制御UI/HTTP API 計画

## 目的
- GUIなしでもブラウザからGPU Upsamplerデーモンの設定/状態確認を行えるようにする。
- 将来のパラメトリックEQ→FIR展開ステージも同じAPI経由で制御できるように、拡張性を確保する。
- 既存のCLI/スクリプト運用を補完し、再配線・再起動・ゲイン/バッファ調整を簡略化する。

## 最小実装スコープ
1. HTTPサーバ（デーモン内に組込み、ポートはlocalhostのみで開始）。
2. API:
   - `GET /status`: 現在の設定と状態を返す（ALSAデバイス、バッファ/period、アップサンプル倍率、ゲイン、クリッピング統計、PipeWire接続状態）。
   - `POST /settings`: 設定更新（ALSAデバイス、バッファ/period、ゲイン、アップサンプル倍率）。一部は即時反映、再起動が必要な項目はレスポンスで通知。
   - `POST /restart`: デーモン再起動トリガ（設定を保持したまま、ALSA/PW再初期化）。
   - `POST /rewire`: PipeWireの配線（app→sink→GPU Input）を再設定。引数にアプリ名（例: spotify）を受け取る。
   - （将来用）`POST /eq-profile`: パラメトリックEQプロファイルを受け取り、FIR係数を更新するエンドポイントの型だけ定義。
3. 簡易Web UI（`static/`配下の単一HTML/JS）:
   - 設定フォーム: ALSAデバイス、バッファ/period、ゲイン、アップサンプル倍率。
   - 操作ボタン: Restart、Rewire（アプリ名指定）、Save settings。
   - ステータス表示: 現在の設定、クリッピング率、PipeWire状態。
   - ダーク/ライト切替不要、プレーンなUIでOK。
4. 認証/公開範囲:
   - 当面は `localhost` バインドのみ、LAN公開なし。
   - 簡易トークン認証（ヘッダに固定トークン）を入れるスペースを残すが、初期値は無効。

## 実装方針
- HTTPサーバ: C++11/17で最小の組込サーバ（例: civetwebやBoostなしの簡易実装）。依存を増やしたくない場合は自前で簡易HTTPパーサを実装しlocalhost専用で動かす。
- 設定の保持: `config.json`（例）にシリアライズし、起動時に読み込み。POSTで更新したら保存。再起動時に復元。
- PipeWire配線: 既存の `setup_pw_links.sh` 相当の処理をC++側に組み込むか、`pw-link` のサブプロセス実行で対応（第一版はサブプロセスでOK）。
- 安全性: ループ中での設定更新はmutex保護。ALSA再初期化を伴う項目は`POST /restart`で明示的に適用。

## タイムライン（優先順位）
1. HTTPサーバの骨組み＋`GET /status` の実装。
2. `POST /settings`（ゲイン/バッファ/period/デバイス/アップサンプル倍率）と設定ファイル保存。
3. `POST /restart` と `POST /rewire`（内部で`pw-link`呼び出し）。
4. Web UI（HTML/JS）でフォームとボタンを配置し、APIに接続。
5. 将来のEQ用に `POST /eq-profile` のスキーマだけ定義（実装は後続）。

## 補足
- すべてローカル完結の設計とし、ネットワーク公開や認証は要望が出てから強化する。
- UIは「設定→保存→再起動」の3ステップが簡単にできれば十分。 테이블形式の設定表示とシンプルな入力欄で実装する。
