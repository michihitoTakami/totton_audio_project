# 開発仕様書: GPU駆動 高精度オーディオ・オーバーサンプリング・プラグイン

## 1. プロジェクト概要
**目的:**
Linuxオーディオ環境（PipeWire / Easy Effects）において、GPUの演算能力を活用した**「超高精度・超ロングタップFIRフィルタ」**によるアップサンプリングを実現する。
既存のDACチップ内蔵フィルタやCPUベースの処理では不可能なレベルのフィルタ性能（急峻な遮断特性と理想的なインパルス応答）により、デジタルオーディオ再生の品質を極限まで高めることを目的とする。

**ターゲット環境:**
* **OS:** Linux (PipeWire環境)
* **ホスト:** Easy Effects (LV2プラグイン形式を想定)
* **ハードウェア:** NVIDIA GeForce RTX 2070 Super (VRAM 8GB) 以上
* **入力:** 44.1kHz / 48kHz (16-32bit Float)
* **出力:** 705.6kHz / 768kHz (x16 オーバーサンプリング)

## 2. アルゴリズム仕様 (DSP Core)

本プロジェクトの核心となる信号処理の仕様です。

### A. フィルタ設計方針
* **種類:** FIRフィルタ (Finite Impulse Response)
* **タップ数:** **131,072 taps (128k)**
    * *意図:* 可聴域内のリップル排除、および遷移帯域の理想的な遮断特性を実現するため。
* **位相特性:** **Minimum Phase (最小位相)**
    * *必須要件:* 線形位相（Linear Phase）で発生するプリリンギング（Pre-ringing）を完全に排除すること。インパルス応答のエネルギーを時間軸の先頭に集中させ、トランジェントの再現性を最優先する。
* **周波数特性 (アポダイジング):**
    * **Passband End:** 20,000 Hz
    * **Stopband Start:** 22,050 Hz (44.1k入力時)
    * **減衰量:** Stopbandにおいて -180dB 以下
    * *窓関数:* Kaiser Window ($\beta \approx 18$) などを適用し、20kHzから緩やかに減衰を開始、ナイキスト周波数で完全に消滅させる。

### B. アップサンプリング処理
* **倍率:** 整数倍 (x16推奨)
    * 44.1kHz → 705.6kHz
    * 48kHz → 768kHz
* **手法:** ゼロ詰め（Zero-stuffing）後のフィルタリング、またはPolyphase分解による効率化。

## 3. 実装アーキテクチャ

### A. 技術スタック推奨
* **言語:** C++ (C++17以上推奨)
* **GPU API:** **Vulkan Compute** または **CUDA**
    * *推奨:* **Vulkan + VkFFT**
        * 理由: 特定ベンダー(NVIDIA)への依存度が低く、Linuxデスクトップアプリとしての親和性が高い。VkFFTライブラリが非常に高速。
    * *代替:* CUDA (cuFFT)
        * 理由: 実装コストが低く、RTX 2070Sの性能を確実に引き出せる。プロトタイプ段階ではこちらでも可。
* **Plugin規格:** LV2 (Linux Audio Developer's Simple Plugin API)

### B. 処理パイプライン (Data Flow)
巨大なタップ数を扱うため、単純な積和演算ではなくFFTコンボリューションを採用する。

1.  **Input Buffer (CPU):** PipeWireからのオーディオブロックを受け取る。
2.  **Ring Buffer Accumulation:** GPU転送効率を高めるため、一定サイズ（例: 4096〜8192サンプル）になるまでデータを溜める。
3.  **H2D Transfer:** CPU → GPU VRAMへ転送。
4.  **Partitioned FFT Convolution (GPU):**
    * フィルタ係数（131k taps）は事前にGPUメモリにロード済み。
    * 入力信号をブロック分割し、Overlap-Save または Overlap-Add 法を用いてFFT畳み込みを行う。
5.  **D2H Transfer:** GPU → CPUへ処理済みデータを転送。
6.  **Output Buffer (CPU):** ホストアプリケーションへ出力。

## 4. 開発フェーズとマイルストーン

### Phase 1: アルゴリズム検証と係数生成 (Python)
* **タスク:**
    * `scipy.signal` を用いて、指定スペック（131k taps, Minimum Phase）の係数を生成するスクリプトを作成。
    * インパルス応答と周波数特性をプロットし、仕様を満たしているか確認。
    * 生成した係数をバイナリまたはヘッダファイルとしてエクスポートする仕組みの作成。
* **成果物:** Pythonスクリプト、フィルタ係数データファイル。

### Phase 2: GPUコンボリューションエンジンの実装 (C++)
* **タスク:**
    * オーディオ入出力を行わない、純粋なC++コンソールアプリを作成。
    * WAVファイルを読み込み、GPU (Vulkan/CUDA) 上でFFTコンボリューションを行い、書き出す。
    * **性能検証:** RTX 2070Sにて、実時間に対して十分な余裕（例: 負荷率20%以下）があるかベンチマーク。
* **成果物:** スタンドアロン変換プログラム。

### Phase 3: リアルタイム・プラグイン化 (LV2)
* **タスク:**
    * LV2プラグインのフレームワークにPhase 2のエンジンを統合。
    * リングバッファの実装（非同期処理による音切れ防止）。
    * PipeWire環境でのサンプリングレート・ネゴシエーションの調査と実装（入力48k/出力High-Resのハンドリング）。
* **成果物:** Easy Effectsで動作する `.so` ファイル。

## 5. 懸念事項と解決方針 (Risk Management)

1.  **レイテンシ:**
    * **課題:** FFTブロック処理とバッファリングにより、数十ms〜100ms程度のレイテンシが発生する可能性がある。
    * **方針:** 音楽鑑賞用（リスニング用途）と割り切り、低レイテンシよりも音質と安定性を優先する。LV2のレイテンシ報告機能を使用し、映像との同期ズレ（リップシンク）はホスト側で補正させる。
2.  **PipeWireのレート変更:**
    * **課題:** 通常のエフェクトプラグインは「入力レート＝出力レート」が前提の場合が多い。
    * **方針:** PipeWireの設定でシステム全体のクロックを最大（768kHz等）に固定し、プラグイン内では「間引き処理 → フィルタ処理」を行うか、あるいはアップサンプリング専用のSinkとして実装するアプローチを検討する。

---

## 6. 参考資料 / 類似技術
* **HQPlayer:** 本プロジェクトが目指す音質品質のベンチマーク。
* **VkFFT:** Vulkanベースの高速FFTライブラリ (GitHub)。
* **CamillaDSP:** Linux上のFIRフィルタエンジン（CPUベースだが構成の参考に）。

以上
