# セキュリティ最低ライン（LAN前提）

Issue: #1062（Epic: #1051）

このプロジェクトは「**LAN内（またはUSB直結）での運用**」を前提にしています。現状のWeb UI/APIは **認証なし**で動作するため、**インターネットへの公開は禁止/強く非推奨**です。

---

## 要点（結論）

- **インターネット公開は禁止/非推奨**（ルータのポート開放、クラウド公開、グローバルIPでの待受はしない）
- **デフォルトの待受は安全側**（Jetsonの本番は USB gadget の `192.168.55.1` に限定）
- **CORSは“安全装置”ではない**（ブラウザ制約であり、ネットワーク到達性を代替しない）
- **ログと設定/キャッシュは機密扱い**（環境情報・IP・パス等が含まれうる）

---

## デフォルト設定（bind / port / CORS）

### Web UI / API の待受（デフォルト）

- **開発（PC）**: `uv run python web/main.py` は `127.0.0.1:11881` にバインド（外部アクセス不可）
- **Jetson（systemd）**: `totton-audio-web.service` は **`192.168.55.1:80` にバインド**（USB Ethernet のみ想定）
- **Jetson（Docker評価版）**: runtime compose はデフォルトで **`192.168.55.1:80` を公開**（USB Ethernet のみ想定）
  - `TOTTON_AUDIO_PUBLISH_IP=0.0.0.0` で明示的に公開先を上書き可能（ただしインターネット公開は禁止/非推奨）

> 注: Jetson側のUSB Ethernetは `docs/jetson/network/usb-ethernet.md` を参照（Jetson: `192.168.55.1`, PC: `192.168.55.100`）。

### CORS（Cross-Origin）

現状、FastAPIの `CORSMiddleware` はデフォルトでは有効化していません。

- **ブラウザからのクロスオリジン呼び出し**は（CORS未許可のため）通常ブロックされます
- しかし、**curl等の非ブラウザ**はCORSの影響を受けないため、**ネットワーク的に到達できる相手にはAPIが到達**します

したがって、**CORSは防御線ではなく補助的な制約**と捉えてください。

---

## 禁止/非推奨（インターネット公開）

以下は **禁止または強く非推奨**です。

- ルータのポート開放で Web UI/API を外部公開する
- 公開クラウド/VPS等で待ち受ける（グローバルIPで `0.0.0.0:80` など）
- リバプロを置いても **認証なし**で公開する（検索エンジン/攻撃スキャンに晒される）

どうしても遠隔アクセスが必要な場合は、以下のいずれかを採用してください。

- **VPN（推奨）**
- **SSHトンネル**
- **リバースプロキシ + 強い認証（Basic/OIDC等） + 送信元制限**

---

## LAN内運用の最低ライン（推奨）

- **待受インターフェースを限定**する（例: USB gadget の `192.168.55.1` のみ）
- **ファイアウォールで送信元を限定**する（例: `usb0` のみ許可）
- JetsonがWi-Fi/有線LANに接続される場合は、**Web UI の公開先が意図せず広がらない**ように確認する
  - `ss -tlnp | grep -E ':80\\b|:11881\\b'`

---

## ログ/データ取り扱い（注意喚起）

### ログ

ログには以下が含まれうるため、**社外共有・チケット添付時は機密情報として扱い、必要に応じてマスク**してください。

- IPアドレス、デバイス名、環境情報（OS/カーネル/デバイス列挙）
- ファイルパス、設定値、失敗理由（スタックトレース等）

Jetson(systemd) のログ取得例は `docs/jetson/troubleshooting.md`、Docker評価版は `docs/jetson/evaluator_guide_docker.md` を参照してください。

### 設定/キャッシュ

- **設定ファイル**（例: `/opt/totton_audio/config/`）: デバイスや運用条件を含むため機密扱い
- **OPRAキャッシュ**（例: `/data/opra`）: 個人情報は通常含まれませんが、配布/共有は必要最小限に

---

## 運用前のセルフチェック（推奨）

- [ ] Web UI が意図したインターフェースにのみバインドされている
- [ ] ファイアウォール（可能なら）で `usb0` / 特定サブネットのみ許可している
- [ ] ルータ等での外部公開（ポート開放）をしていない
