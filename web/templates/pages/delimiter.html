{% extends "base.html" %}
{% import "components/buttons.html" as buttons %}
{% import "components/card_panel.html" as panels %}
{% import "components/toggle_switch.html" as toggles %}
{% import "components/status_card.html" as status_card %}

{% block title %}{{ t.get('nav.delimiter') }} - {{ t.get('app.title') }}{% endblock %}

{% block content %}
<div x-data="delimiterPage()" x-init="init()">
    <div class="page-header">
        <h1 class="page-title">{{ t.get('nav.delimiter') }}</h1>
        <p class="page-subtitle">{{ t.get('delimiter.subtitle') }}</p>
    </div>

    <div class="section">
        <h2 class="section-title">{{ t.get('system.delimiter.status_title') }}</h2>
        <div class="card-grid">
            {% set status_icon = "üéõÔ∏è" %}
            {% set status_title = t.get('system.delimiter.state') %}
            {% set status_class = "delimiter.enabled ? (delimiter.backendValid ? 'status-ok' : 'status-error') : 'status-off'" %}
            {% set status_text = "delimiterStatusLabel()" %}
            {% set status_subtext = "delimiter.backendValid ? '" ~ t.get('system.delimiter.backend_valid') ~ "' : '" ~ t.get('system.delimiter.backend_invalid') ~ "'" %}
            {% include 'components/status_card.html' %}

            {% set status_icon = "üîÑ" %}
            {% set status_title = t.get('system.delimiter.mode') %}
            {% set status_class = "delimiter.mode !== 'unknown' ? 'status-ok' : 'status-off'" %}
            {% set status_text = "delimiter.mode" %}
            {% set status_subtext = "`" ~ t.get('system.delimiter.target_mode') ~ ": ${delimiter.target_mode}`" %}
            {% include 'components/status_card.html' %}

            {% set status_icon = "‚ö†Ô∏è" %}
            {% set status_title = t.get('system.delimiter.fallback') %}
            {% set status_class = "delimiter.fallback_reason === 'none' || delimiter.fallback_reason === 'unknown' ? 'status-ok' : 'status-info'" %}
            {% set status_text = "delimiter.fallback_reason" %}
            {% set status_subtext = "delimiter.bypass_locked ? '" ~ t.get('system.delimiter.locked') ~ "' : ''" %}
            {% include 'components/status_card.html' %}

            {% set status_icon = "üìä" %}
            {% set status_title = t.get('system.delimiter.queue') %}
            {% set status_class = "'status-info'" %}
            {% set status_text = "formatQueueSeconds()" %}
            {% set status_subtext = "`${delimiter.queue_samples} " ~ t.get('system.delimiter.queue_samples') ~ "`" %}
            {% include 'components/status_card.html' %}

            {% set status_icon = "‚è±Ô∏è" %}
            {% set status_title = t.get('system.delimiter.last_inference') %}
            {% set status_class = "delimiter.last_inference_ms > 0 ? 'status-ok' : 'status-off'" %}
            {% set status_text = "formatInferenceMs()" %}
            {% include 'components/status_card.html' %}

            {% set status_icon = "üìù" %}
            {% set status_title = t.get('system.delimiter.detail') %}
            {% set status_class = "'status-info'" %}
            {% set status_text = "delimiter.detail || '" ~ t.get('system.delimiter.no_detail') ~ "'" %}
            {% include 'components/status_card.html' %}
        </div>
    </div>

    {% call panels.card_panel(t.get('system.delimiter.title')) %}
        <div class="card-row wrap">
            {% set toggle_id = "delimiter-toggle" %}
            {% set toggle_label = t.get('system.delimiter.toggle') %}
            {% set toggle_desc = t.get('system.delimiter.desc') %}
            {% set alpine_model = "delimiter.enabled" %}
            {% set alpine_click = "toggleDelimiter()" %}
            {% set alpine_disabled = "delimiter.loading || actionInProgress || !health.daemon_running" %}
            {% include 'components/toggle_switch.html' %}
            {{ buttons.btn_primary(t.get('system.delimiter.refresh'), icon='üîÑ', click='fetchDelimiter()', disabled='delimiter.loading', extra_class='btn-secondary') }}
        </div>
        <div class="muted small">{{ t.get('system.delimiter.latency_notice') }}</div>

        <div class="alert alert-warning" x-show="delimiter.enabled && !delimiter.backendAvailable">
            <span x-text="delimiter.backendHint"></span>
        </div>
        <div class="alert alert-warning" x-show="delimiter.error">
            <span x-text="delimiter.error"></span>
        </div>
    {% endcall %}
</div>
{% endblock %}

{% block extra_scripts %}
<script>
function delimiterPage() {
    return {
        health: { daemon_running: false },
        delimiter: {
            loading: false,
            enabled: false,
            backendAvailable: false,
            backendValid: false,
            warmup: false,
            mode: 'unknown',
            target_mode: 'unknown',
            fallback_reason: 'unknown',
            bypass_locked: false,
            queue_seconds: 0,
            queue_samples: 0,
            last_inference_ms: 0,
            detail: '',
            error: '',
            backendHint: "{{ t.get('system.delimiter.backend_hint') }}",
        },
        actionInProgress: false,

        init() {
            this.refreshAll();
            setInterval(() => {
                this.fetchStatus();
                this.fetchDelimiter();
            }, 5000);
        },

        async refreshAll() {
            await Promise.all([this.fetchStatus(), this.fetchDelimiter()]);
        },

        async fetchStatus() {
            try {
                const res = await fetch('/status');
                if (!res.ok) return;
                const data = await res.json();
                this.health.daemon_running = data.daemon_running;
            } catch (err) {
                console.error('status fetch failed', err);
            }
        },

        applyDelimiterStatus(status) {
            const safe = status && typeof status === 'object' ? status : {};
            this.delimiter.enabled = Boolean(safe.enabled);
            this.delimiter.backendAvailable = Boolean(safe.backend_available);
            this.delimiter.backendValid = Boolean(safe.backend_valid);
            this.delimiter.warmup = Boolean(safe.warmup);
            this.delimiter.mode = safe.mode || 'unknown';
            this.delimiter.target_mode = safe.target_mode || 'unknown';
            this.delimiter.fallback_reason = safe.fallback_reason || 'unknown';
            this.delimiter.bypass_locked = Boolean(safe.bypass_locked);
            this.delimiter.queue_seconds = Number(safe.queue_seconds || 0);
            this.delimiter.queue_samples = Number(safe.queue_samples || 0);
            this.delimiter.last_inference_ms = Number(safe.last_inference_ms || 0);
            this.delimiter.detail = safe.detail || '';
        },

        async fetchDelimiter() {
            this.delimiter.loading = true;
            this.delimiter.error = '';
            try {
                const res = await fetch('/delimiter/status');
                const data = await res.json().catch(() => ({}));
                if (!res.ok) {
                    throw new Error(data.detail || data.message || 'Failed to fetch De-limiter');
                }
                this.applyDelimiterStatus(data);
            } catch (err) {
                this.delimiter.error = err.message;
                this.delimiter.backendAvailable = false;
            } finally {
                this.delimiter.loading = false;
            }
        },

        delimiterStatusLabel() {
            if (!this.health.daemon_running) {
                return '{{ t.get("system.delimiter.status_daemon_down") }}';
            }
            if (!this.delimiter.backendAvailable) {
                return '{{ t.get("system.delimiter.status_unavailable") }}';
            }
            if (this.delimiter.bypass_locked) {
                return '{{ t.get("system.delimiter.status_locked") }}';
            }
            if (this.delimiter.enabled) {
                return this.delimiter.warmup
                    ? '{{ t.get("system.delimiter.status_warmup") }}'
                    : '{{ t.get("system.delimiter.status_on") }}';
            }
            return '{{ t.get("system.delimiter.status_off") }}';
        },

        formatQueueSeconds() {
            const seconds = Number(this.delimiter.queue_seconds || 0);
            return `${seconds.toFixed(2)} s`;
        },

        formatInferenceMs() {
            const ms = Number(this.delimiter.last_inference_ms || 0);
            return `${ms.toFixed(2)} ms`;
        },

        async toggleDelimiter() {
            if (this.delimiter.loading || this.actionInProgress) return;
            const enable = !this.delimiter.enabled;
            this.delimiter.loading = true;
            this.actionInProgress = true;
            try {
                const res = await fetch(enable ? '/delimiter/enable' : '/delimiter/disable', {
                    method: 'POST',
                });
                const data = await res.json().catch(() => ({}));
                if (!res.ok) {
                    throw new Error(data.detail || data.message || 'Toggle failed');
                }
                const status = data.status || data;
                this.applyDelimiterStatus(status);
                showToast(
                    enable
                        ? '{{ t.get("system.delimiter.toast_enabled") }}'
                        : '{{ t.get("system.delimiter.toast_disabled") }}',
                    'success'
                );
            } catch (err) {
                this.delimiter.error = err.message;
                showToast(err.message, 'error');
            } finally {
                this.delimiter.loading = false;
                this.actionInProgress = false;
            }
        },
    };
}
</script>
{% endblock %}
