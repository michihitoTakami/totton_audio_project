{% extends "base.html" %}

{% block title %}{{ t.get('nav.rtp') }} - {{ t.get('app.title') }}{% endblock %}

{% block extra_scripts %}
<script>
// i18n translations for JavaScript
window.i18n = {
    'rtp.scan.success': '{{ t.get("rtp.scan.success") }}',
    'rtp.scan.error': '{{ t.get("rtp.scan.error") }}',
    'rtp.connect.success': '{{ t.get("rtp.connect.success") }}',
    'rtp.connect.error': '{{ t.get("rtp.connect.error") }}',
    'rtp.sessions.confirm_stop': '{{ t.get("rtp.sessions.confirm_stop") }}',
    'rtp.sessions.stopped': '{{ t.get("rtp.sessions.stopped") }}',
    'rtp.sessions.stop_error': '{{ t.get("rtp.sessions.stop_error") }}',
    'rtp.config.saved_no_restart': '{{ t.get("rtp.config.saved_no_restart") }}',
    'rtp.config.applied': '{{ t.get("rtp.config.applied") }}',
    'rtp.config.apply_error': '{{ t.get("rtp.config.apply_error") }}'
};

// i18n helper function
function t(key, params = {}) {
    let text = window.i18n[key] || key;
    // Replace {param} placeholders
    for (const [k, v] of Object.entries(params)) {
        text = text.replace(`{${k}}`, v);
    }
    return text;
}
</script>
<script src="/static/js/rtp_management.js"></script>
{% endblock %}

{% block content %}
<div x-data="rtpManagementData()" x-init="init()">
    <!-- Page Header -->
    <div class="page-header">
        <h1 class="page-title">{{ t.get('nav.rtp') }}</h1>
        <p class="page-subtitle">{{ t.get('rtp.subtitle') }}</p>
    </div>

    <!-- Active Sessions Section -->
    <div class="section">
        <h2 class="section-title">{{ t.get('rtp.sessions.title') }}</h2>
        <div class="card">
            <template x-if="sessions && sessions.length > 0">
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>{{ t.get('rtp.sessions.table.id') }}</th>
                                <th>{{ t.get('rtp.sessions.table.host') }}</th>
                                <th>{{ t.get('rtp.sessions.table.port') }}</th>
                                <th>{{ t.get('rtp.sessions.table.status') }}</th>
                                <th>{{ t.get('rtp.sessions.table.packets') }}</th>
                                <th>{{ t.get('rtp.sessions.table.action') }}</th>
                            </tr>
                        </thead>
                        <tbody>
                            <template x-for="session in sessions" :key="session.session_id">
                                <tr>
                                    <td x-text="session.session_id"></td>
                                    <td x-text="session.source_host || '-'"></td>
                                    <td x-text="session.port || '-'"></td>
                                    <td>
                                        <span :class="session.packets_received > 0 ? 'status-badge status-ok' : 'status-badge status-off'"
                                              x-text="session.packets_received > 0 ? '{{ t.get('rtp.sessions.status.active') }}' : '{{ t.get('rtp.sessions.status.idle') }}'"></span>
                                    </td>
                                    <td x-text="session.packets_received"></td>
                                    <td @click.stop>
                                        {% set button_label = t.get('rtp.sessions.stop') %}
                                        {% set button_type = "secondary" %}
                                        {% set alpine_click = "stopSession(session.session_id)" %}
                                        {% set button_class = "btn-sm" %}
                                        {% include 'components/action_button.html' %}
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </template>
            <template x-if="!sessions || sessions.length === 0">
                {% set info_message = t.get('rtp.sessions.no_sessions') %}
                {% include 'components/info_text.html' %}
            </template>
        </div>
    </div>

    <!-- Latency Settings Section -->
    <div class="section">
        <h2 class="section-title">{{ t.get('rtp.config.title') }}</h2>
        <div class="card">
            <!-- Target Latency Button Selection -->
            <div class="form-group">
                <label class="form-label">{{ t.get('rtp.config.latency') }}</label>
                <div class="btn-group">
                    <button type="button"
                            class="btn btn-secondary btn-group-item"
                            :class="{'active': rtpConfig.latency_preset == '100'}"
                            @click="rtpConfig.latency_preset = '100'; rtpConfig.target_latency_ms = 100">
                        {{ t.get('rtp.config.latency.stable') }}
                    </button>
                    <button type="button"
                            class="btn btn-secondary btn-group-item"
                            :class="{'active': rtpConfig.latency_preset == '50'}"
                            @click="rtpConfig.latency_preset = '50'; rtpConfig.target_latency_ms = 50">
                        {{ t.get('rtp.config.latency.normal') }}
                    </button>
                    <button type="button"
                            class="btn btn-secondary btn-group-item"
                            :class="{'active': rtpConfig.latency_preset == '20'}"
                            @click="rtpConfig.latency_preset = '20'; rtpConfig.target_latency_ms = 20">
                        {{ t.get('rtp.config.latency.low') }}
                    </button>
                    <button type="button"
                            class="btn btn-secondary btn-group-item"
                            :class="{'active': rtpConfig.latency_preset == '5'}"
                            @click="rtpConfig.latency_preset = '5'; rtpConfig.target_latency_ms = 5">
                        {{ t.get('rtp.config.latency.ultra') }}
                    </button>
                    <button type="button"
                            class="btn btn-secondary btn-group-item"
                            :class="{'active': rtpConfig.latency_preset == 'custom'}"
                            @click="rtpConfig.latency_preset = 'custom'">
                        {{ t.get('rtp.config.latency.custom') }}
                    </button>
                </div>
            </div>

            <div x-show="rtpConfig.latency_preset === 'custom'">
                {% set form_label = t.get('rtp.config.latency') + " (ms)" %}
                {% set form_input_type = "text" %}
                {% set form_input_model = "rtpConfig.target_latency_ms" %}
                {% set form_input_placeholder = "100" %}
                {% include 'components/form_group.html' %}
            </div>

            <div class="btn-row">
                {% set button_label = t.get('rtp.config.apply') %}
                {% set alpine_click = "applyLatencyConfig" %}
                {% set button_disabled = "applyingConfig" %}
                {% include 'components/action_button.html' %}
            </div>

            {% set alert_type = "info" %}
            {% set alert_show = "true" %}
            {% set alert_message = t.get('rtp.config.latency_note') %}
            {% include 'components/alert.html' %}
        </div>
    </div>

    <!-- Advanced Section (Collapsible) -->
    <div class="section" x-data="{ advancedOpen: false }">
        <h2 class="section-title" @click="advancedOpen = !advancedOpen" style="cursor: pointer;">
            <span x-show="!advancedOpen">‚ñ∂</span>
            <span x-show="advancedOpen">‚ñº</span>
            {{ t.get('rtp.advanced.title') }}
        </h2>

        <div x-show="advancedOpen">
            <!-- Manual Connection -->
            <div class="card" style="margin-bottom: 20px;">
                <h3 class="subsection-title">{{ t.get('rtp.advanced.manual_connection') }}</h3>

                <div class="btn-row">
                    {% set button_label = t.get('rtp.scan.button') %}
                    {% set alpine_click = "scanStreams" %}
                    {% set button_disabled = "scanning" %}
                    {% include 'components/action_button.html' %}
                </div>

                <!-- Scan Status -->
                <div x-show="scanning">
                    {% set info_message = t.get('rtp.scan.scanning') %}
                    {% set info_icon = "üîç" %}
                    {% include 'components/info_text.html' %}
                </div>

                <!-- Last Scan Info -->
                <div x-show="!scanning && scanResult.scanned_at_unix_ms">
                    <div class="info-text">
                        <span class="icon">‚ÑπÔ∏è</span>
                        <span>
                            {{ t.get('rtp.scan.last_scan') }}:
                            <span x-text="formatTimestamp(scanResult.scanned_at_unix_ms)"></span>
                            <template x-if="scanResult.duration_ms">
                                ({{ t.get('rtp.scan.duration') }}: <span x-text="scanResult.duration_ms"></span>{{ t.get('common.units.ms') }})
                            </template>
                        </span>
                    </div>
                </div>

                <!-- Discovered Streams Table -->
                <template x-if="scanResult.streams && scanResult.streams.length > 0">
                    <div class="table-container" style="margin-top: 16px;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>{{ t.get('rtp.scan.table.name') }}</th>
                                    <th>{{ t.get('rtp.scan.table.host') }}</th>
                                    <th>{{ t.get('rtp.scan.table.port') }}</th>
                                    <th>{{ t.get('rtp.scan.table.status') }}</th>
                                    <th>{{ t.get('rtp.scan.table.sample_rate') }}</th>
                                    <th>{{ t.get('rtp.scan.table.channels') }}</th>
                                    <th>{{ t.get('rtp.scan.table.action') }}</th>
                                </tr>
                            </thead>
                            <tbody>
                                <template x-for="stream in scanResult.streams" :key="stream.session_id">
                                    <tr>
                                        <td x-text="stream.display_name"></td>
                                        <td x-text="stream.source_host || '-'"></td>
                                        <td x-text="stream.port"></td>
                                        <td x-text="stream.status"></td>
                                        <td x-text="stream.sample_rate ? (stream.sample_rate / 1000) + '{{ t.get('common.units.khz') }}' : '-'"></td>
                                        <td x-text="stream.channels || '-'"></td>
                                        <td>
                                            <template x-if="!stream.existing_session">
                                                {% set button_label = t.get('rtp.scan.connect') %}
                                                {% set button_type = "secondary" %}
                                                {% set alpine_click = "connectStream(stream)" %}
                                                {% set button_class = "btn-sm" %}
                                                {% include 'components/action_button.html' %}
                                            </template>
                                            <template x-if="stream.existing_session">
                                                <span class="status-badge status-ok">{{ t.get('rtp.scan.connected') }}</span>
                                            </template>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </template>

                <template x-if="!scanning && scanResult.streams && scanResult.streams.length === 0">
                    {% set info_message = t.get('rtp.scan.no_streams') %}
                    {% include 'components/info_text.html' %}
                </template>
            </div>

            <!-- Session Telemetry -->
            <div class="card">
                <h3 class="subsection-title">{{ t.get('rtp.telemetry.title') }}</h3>
                <template x-if="!selectedSessionId">
                    {% set info_message = t.get('rtp.telemetry.select') %}
                    {% include 'components/info_text.html' %}
                </template>

                <template x-if="selectedSessionId && selectedSession">
                    <div class="telemetry-grid">
                        <div class="telemetry-item">
                            <span class="telemetry-label">{{ t.get('rtp.telemetry.packets_received') }}:</span>
                            <span class="telemetry-value" x-text="selectedSession.packets_received"></span>
                        </div>
                        <div class="telemetry-item">
                            <span class="telemetry-label">{{ t.get('rtp.telemetry.bytes_received') }}:</span>
                            <span class="telemetry-value" x-text="formatBytes(selectedSession.bytes_received)"></span>
                        </div>
                        <div class="telemetry-item">
                            <span class="telemetry-label">{{ t.get('rtp.telemetry.late_packets') }}:</span>
                            <span class="telemetry-value" x-text="selectedSession.late_packets"></span>
                        </div>
                        <div class="telemetry-item">
                            <span class="telemetry-label">{{ t.get('rtp.telemetry.jitter') }}:</span>
                            <span class="telemetry-value" x-text="(selectedSession.network_jitter_usec / 1000).toFixed(2) + ' {{ t.get("common.units.ms") }}'"></span>
                        </div>
                        <div class="telemetry-item">
                            <span class="telemetry-label">{{ t.get('rtp.telemetry.sample_rate') }}:</span>
                            <span class="telemetry-value" x-text="selectedSession.sample_rate ? (selectedSession.sample_rate / 1000) + ' {{ t.get("common.units.khz") }}' : '-'"></span>
                        </div>
                        <div class="telemetry-item">
                            <span class="telemetry-label">{{ t.get('rtp.telemetry.last_packet') }}:</span>
                            <span class="telemetry-value" x-text="selectedSession.last_packet_unix_ms ? formatTimestamp(selectedSession.last_packet_unix_ms) : '-'"></span>
                        </div>
                    </div>
                </template>
            </div>
        </div>
    </div>
</div>
{% endblock %}
