{% extends "base.html" %}
{% import "components/buttons.html" as buttons %}
{% import "components/card_panel.html" as panels %}
{% import "components/status_card.html" as status_card %}
{% import "components/key_value_row.html" as kv %}

{% block title %}{{ t.get('nav.system') }} - {{ t.get('app.title') }}{% endblock %}

{% block content %}
<div x-data="systemPage()" x-init="init()">
    <div class="page-header">
        <h1 class="page-title">{{ t.get('nav.system') }}</h1>
        <p class="page-subtitle">{{ t.get('system.subtitle') }}</p>
    </div>

    {% call panels.card_panel(t.get('system.language.title')) %}
        <div class="card-row wrap">
            <div class="stack">
                <div class="muted">{{ t.get('system.language.description') }}</div>
            </div>
            {{ buttons.btn_primary(t.get('system.language.english'), icon='üá∫üá∏', click="switchLanguage('en')", extra_class='btn-secondary', attrs=':class="{ active: currentLang === &quot;en&quot; }" :aria-pressed="currentLang === &quot;en&quot;"') }}
            {{ buttons.btn_primary(t.get('system.language.japanese'), icon='üáØüáµ', click="switchLanguage('ja')", extra_class='btn-secondary', attrs=':class="{ active: currentLang === &quot;ja&quot; }" :aria-pressed="currentLang === &quot;ja&quot;"') }}
        </div>
    {% endcall %}

    <div class="section">
        <h2 class="section-title">{{ t.get('system.health.title') }}</h2>
        <div class="card-grid">
            {% set status_icon = "‚öôÔ∏è" %}
            {% set status_title = t.get('system.health.daemon') %}
            {% set status_class = "health.daemon_running ? 'status-ok' : 'status-error'" %}
            {% set status_text = "health.daemon_running ? '" ~ t.get('system.daemon.running') ~ "' : '" ~ t.get('system.daemon.stopped') ~ "'" %}
            {% include 'components/status_card.html' %}

            {% set status_icon = "üéöÔ∏è" %}
            {% set status_title = t.get('system.health.input_rate') %}
            {% set status_class = "health.input_rate > 0 ? 'status-ok' : 'status-off'" %}
            {% set status_text = "health.input_rate ? `${health.input_rate} Hz` : '" ~ t.get('system.health.na') ~ "'" %}
            {% include 'components/status_card.html' %}

            {% set status_icon = "üéõÔ∏è" %}
            {% set status_title = t.get('system.health.output_rate') %}
            {% set status_class = "health.output_rate > 0 ? 'status-ok' : 'status-off'" %}
            {% set status_text = "health.output_rate ? `${health.output_rate} Hz` : '" ~ t.get('system.health.na') ~ "'" %}
            {% include 'components/status_card.html' %}
        </div>
    </div>

    {% call panels.card_panel(t.get('system.daemon.title')) %}
        <div class="card-row wrap">
            {% set button_label = t.get('dashboard.action.restart_daemon') %}
            {% set button_icon = "üîÑ" %}
            {% set alpine_click = "restartDaemon()" %}
            {% set button_disabled = "actionInProgress" %}
            {% include 'components/action_button.html' %}
        </div>
    {% endcall %}

    {% call panels.card_panel(t.get('system.dac.title')) %}
        <div class="kv-grid">
            {{ kv.kv_row(t.get('system.dac.current'), value_binding="dac.runtime?.active_device || messages.dacNone") }}
            {{ kv.kv_row(t.get('system.dac.sample_rate'), value_binding="formatWithUnit(dac.runtime?.output_rate, 'Hz')") }}
        </div>

        <div class="card-row wrap">
            {{ buttons.btn_primary(t.get('system.dac.rescan'), icon='üîç', click='rescanDac()', disabled='actionInProgress || dac.loading', extra_class='btn-secondary') }}
        </div>

        <div class="form-grid" x-show="dac.devices.length > 0">
            {% set form_label = t.get('system.dac.select') %}
            {% set form_input_type = "select" %}
            {% set form_input_model = "dac.selected" %}
            {% set form_input_disabled = "actionInProgress || dac.loading" %}
            {% set form_on_change = "dac.userSelected = true" %}
            {% set form_select_options = '<template x-for="device in dac.devices" :key="device.id"><option :value="device.id" x-text="device.name ? `${device.name} (${device.id})` : device.id"></option></template>' %}
            {% include 'components/form_group.html' %}
        </div>
        <div class="btn-row" x-show="dac.devices.length > 0">
            {{ buttons.btn_primary(t.get('system.dac.select'), icon='üéß', click='selectDac(dac.selected)', disabled='actionInProgress || !dac.selected || dac.runtime?.active_device === dac.selected', extra_class='btn-secondary') }}
        </div>
        <template x-if="dac.devices.length === 0">
            {% set info_message = t.get('system.dac.no_devices') %}
            {% include 'components/info_text.html' %}
        </template>
    {% endcall %}

    {% call panels.card_panel(t.get('system.partitioned.title')) %}
        <div class="card-row wrap">
            {% set toggle_id = "partitioned-toggle" %}
            {% set toggle_label = t.get('system.partitioned.enable') %}
            {% set toggle_desc = t.get('system.partitioned.desc') %}
            {% set alpine_model = "partitioned.enabled" %}
            {% set alpine_click = "togglePartitioned()" %}
            {% include 'components/toggle_switch.html' %}
        </div>

        <div class="stack" x-show="partitioned.enabled">
            <div class="muted">{{ t.get('system.partitioned.preset.subtitle') }}</div>
            <div class="btn-group">
                {{ buttons.btn_primary(t.get('system.partitioned.preset.low_latency'), icon='‚ö°', click="usePreset('low_latency')", extra_class='btn-group-item', attrs=':class="{ active: partitioned.preset === &quot;low_latency&quot; }"') }}
                {{ buttons.btn_primary(t.get('system.partitioned.preset.balanced'), icon='üéß', click="usePreset('balanced')", extra_class='btn-group-item', attrs=':class="{ active: partitioned.preset === &quot;balanced&quot; }"') }}
            </div>
            <div class="info-text">
                <span class="icon">‚ÑπÔ∏è</span>
                <span x-text="presetDescriptions[partitioned.preset] || presetDescriptions.custom"></span>
            </div>
        </div>

        <div class="kv-grid" x-show="partitioned.enabled">
            {{ kv.kv_row(t.get('system.partitioned.fast_taps'), value_binding="formatNumber(partitioned.fast_partition_taps)") }}
            {{ kv.kv_row(t.get('system.partitioned.min_taps'), value_binding="formatNumber(partitioned.min_partition_taps)") }}
            {{ kv.kv_row(t.get('system.partitioned.max_partitions'), value_binding="formatNumber(partitioned.max_partitions)") }}
            {{ kv.kv_row(t.get('system.partitioned.tail_multiple'), value_binding="formatNumber(partitioned.tail_fft_multiple)") }}
        </div>

        <div class="btn-row" x-show="partitioned.enabled">
            {{ buttons.btn_primary(t.get('system.partitioned.save'), icon='üíæ', click='savePartitioned()', disabled='partitioned.loading || actionInProgress') }}
            {{ buttons.btn_primary(t.get('system.partitioned.reset_defaults'), icon='‚Ü∫', click='resetPartitioned()', disabled='partitioned.loading || actionInProgress', extra_class='btn-secondary') }}
        </div>
    {% endcall %}

    {% call panels.card_panel(t.get('system.buffer.title')) %}
        <div class="kv-grid">
            {{ kv.kv_row(t.get('system.buffer.size'), value_binding="formatNumber(config.bufferSize)") }}
            {{ kv.kv_row(t.get('system.buffer.period'), value_binding="formatNumber(config.periodSize)") }}
            {{ kv.kv_row(t.get('system.gain.gain'), value_binding="formatWithUnit(config.gain, 'dB', 2)") }}
            {{ kv.kv_row(t.get('system.gain.headroom'), value_binding="formatWithUnit(config.headroomTarget, 'dB', 2)") }}
        </div>
    {% endcall %}

    {% call panels.card_panel(t.get('system.debug.title')) %}
        <div class="kv-grid">
            {{ kv.kv_row(t.get('system.debug.xrun_count'), value_binding="formatNumber(debug.xrun_count)") }}
            {{ kv.kv_row(t.get('system.debug.buffer_capacity'), value_binding="formatNumber(debug.buffer_capacity_frames)") }}
            {{ kv.kv_row(t.get('system.debug.dropped_frames'), value_binding="formatNumber(debug.dropped_frames)") }}
            {{ kv.kv_row(t.get('system.debug.rendered_silence_blocks'), value_binding="formatNumber(debug.rendered_silence_blocks)") }}
            {{ kv.kv_row(t.get('system.debug.rendered_silence_frames'), value_binding="formatNumber(debug.rendered_silence_frames)") }}
            {{ kv.kv_row(t.get('system.debug.alsa_buffer_size_config'), value_binding="formatNumber(debug.alsa_buffer_size_config)") }}
            {{ kv.kv_row(t.get('system.debug.alsa_period_size_config'), value_binding="formatNumber(debug.alsa_period_size_config)") }}
        </div>
    {% endcall %}
</div>
{% endblock %}

{% block extra_scripts %}
<script>
function systemPage() {
    return {
        health: { daemon_running: false, input_rate: 0, output_rate: 0 },
        dac: { devices: [], runtime: null, loading: false, selected: '', userSelected: false },
        messages: {
            na: "{{ t.get('system.health.na') }}",
            dacNone: "{{ t.get('system.dac.no_devices') }}",
        },
        partitionedPresets: {
            low_latency: {
                fast_partition_taps: 16384,
                min_partition_taps: 8192,
                max_partitions: 4,
                tail_fft_multiple: 2,
            },
            balanced: {
                fast_partition_taps: 49152,
                min_partition_taps: 8192,
                max_partitions: 6,
                tail_fft_multiple: 4,
            },
        },
        presetDescriptions: {
            low_latency: "{{ t.get('system.partitioned.preset.low_latency_desc') }}",
            balanced: "{{ t.get('system.partitioned.preset.balanced_desc') }}",
            custom: "{{ t.get('system.partitioned.preset.custom_desc') }}",
        },
        currentLang: "{{ lang }}",
        partitioned: {
            enabled: false,
            fast_partition_taps: 49152,
            min_partition_taps: 8192,
            max_partitions: 6,
            tail_fft_multiple: 4,
            loading: false,
            preset: "balanced",
        },
        config: { bufferSize: null, periodSize: null, gain: null, headroomTarget: null },
        debug: {
            xrun_count: 0,
            buffer_capacity_frames: 0,
            dropped_frames: 0,
            rendered_silence_blocks: 0,
            rendered_silence_frames: 0,
            alsa_buffer_size_config: 0,
            alsa_period_size_config: 0,
        },
        actionInProgress: false,

        init() {
            this.refreshAll();
            setInterval(() => {
                this.fetchStatus();
                this.fetchDacState();
            }, 5000);
        },

        async refreshAll() {
            await Promise.all([
                this.fetchStatus(),
                this.fetchDacDevices(),
                this.fetchDacState(),
                this.fetchPartitioned(),
            ]);
        },

        async fetchStatus() {
            try {
                const res = await fetch('/status');
                if (!res.ok) return;
                const data = await res.json();
                this.health.daemon_running = data.daemon_running;
                this.health.input_rate = data.input_rate || 0;
                this.health.output_rate = data.output_rate || 0;
                const settings = data.settings;
                if (settings) {
                    this.config.bufferSize = settings.buffer_size;
                    this.config.periodSize = settings.period_size;
                    this.config.gain = settings.gain;
                    this.config.headroomTarget = settings.headroom_target;
                }
                this.debug.xrun_count = data.xrun_count ?? 0;
                this.debug.buffer_capacity_frames = data.buffer_capacity_frames ?? 0;
                this.debug.dropped_frames = data.dropped_frames ?? 0;
                this.debug.rendered_silence_blocks = data.rendered_silence_blocks ?? 0;
                this.debug.rendered_silence_frames = data.rendered_silence_frames ?? 0;
                this.debug.alsa_buffer_size_config = data.alsa_buffer_size_config ?? 0;
                this.debug.alsa_period_size_config = data.alsa_period_size_config ?? 0;
            } catch (err) {
                console.error('status fetch failed', err);
            }
        },

        async restartDaemon() {
            if (!confirm('{{ t.get("system.confirm.restart") }}')) return;
            this.actionInProgress = true;
            try {
                const res = await fetch('/daemon/restart', { method: 'POST' });
                const data = await res.json().catch(() => ({}));
                if (!res.ok) throw new Error(data.detail || data.message || 'restart failed');
                showToast(data.message || '{{ t.get("system.toast.restart_ok") }}', 'success');
                await this.fetchStatus();
            } catch (err) {
                showToast(err.message, 'error');
            } finally {
                this.actionInProgress = false;
            }
        },

        async fetchDacDevices() {
            this.dac.loading = true;
            try {
                const res = await fetch('/dac/devices');
                const data = await res.json();
                this.dac.devices = data.devices || [];
                // Keep selection stable (prefer active device -> previous selection -> first item)
                const active = this.dac.runtime?.active_device;
                const ids = new Set(this.dac.devices.map(d => d.id));
                if (active && ids.has(active)) {
                    this.dac.selected = active;
                } else if (this.dac.selected && ids.has(this.dac.selected)) {
                    // keep
                } else {
                    this.dac.selected = this.dac.devices[0]?.id || '';
                }
            } catch (err) {
                console.error('dac devices failed', err);
            } finally {
                this.dac.loading = false;
            }
        },

        async fetchDacState() {
            try {
                const res = await fetch('/dac/state');
                if (!res.ok) return;
                this.dac.runtime = await res.json();
                if (
                    this.dac.runtime?.active_device &&
                    (!this.dac.userSelected || !this.dac.selected)
                ) {
                    this.dac.selected = this.dac.runtime.active_device;
                }
            } catch (err) {
                console.error('dac state failed', err);
            }
        },

        async rescanDac() {
            this.actionInProgress = true;
            try {
                await fetch('/dac/rescan', { method: 'POST' });
                await this.fetchDacDevices();
                await this.fetchDacState();
            } catch (err) {
                console.error('dac rescan failed', err);
            } finally {
                this.actionInProgress = false;
            }
        },

        async selectDac(id) {
            if (!id) return;
            if (this.dac.runtime?.active_device === id) return;
            if (!confirm('{{ t.get("system.confirm.switch_dac") }}')) return;
            this.actionInProgress = true;
            try {
                const res = await fetch('/dac/select', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ device: id, persist: true }),
                });
                const data = await res.json().catch(() => ({}));
                if (!res.ok) throw new Error(data.detail || data.message || 'failed');
                showToast(data.message || '{{ t.get("system.toast.dac_ok") }}', 'success');
                await this.fetchDacState();
            } catch (err) {
                showToast(err.message, 'error');
            } finally {
                this.actionInProgress = false;
            }
        },

        async fetchPartitioned() {
            try {
                const res = await fetch('/partitioned-convolution');
                if (!res.ok) return;
                const data = await res.json();
                this.partitioned.enabled = data.enabled;
                this.partitioned.fast_partition_taps = data.fast_partition_taps;
                this.partitioned.min_partition_taps = data.min_partition_taps;
                this.partitioned.max_partitions = data.max_partitions;
                this.partitioned.tail_fft_multiple = data.tail_fft_multiple;
                this.partitioned.preset = this.detectPartitionPreset(data);
            } catch (err) {
                console.error('partitioned fetch failed', err);
            }
        },

        togglePartitioned() {
            this.partitioned.enabled = !this.partitioned.enabled;
        },

        async savePartitioned() {
            this.partitioned.loading = true;
            this.actionInProgress = true;
            try {
                const payload = this.buildPartitionedPayload();
                const res = await fetch('/partitioned-convolution', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                });
                const data = await res.json().catch(() => ({}));
                if (!res.ok || data.success === false) {
                    throw new Error(data.detail || data.message || 'failed');
                }
                showToast(data.message || '{{ t.get("system.partitioned.save") }}', 'success');
                await this.fetchPartitioned();
            } catch (err) {
                showToast(err.message, 'error');
            } finally {
                this.partitioned.loading = false;
                this.actionInProgress = false;
            }
        },

        resetPartitioned() {
            this.usePreset('balanced');
            showToast('{{ t.get("system.partitioned.reset_defaults") }}', 'info');
        },

        usePreset(name) {
            const preset = this.partitionedPresets[name];
            if (!preset) {
                this.partitioned.preset = 'custom';
                return;
            }
            this.partitioned.preset = name;
            this.partitioned.enabled = true;
            this.partitioned.fast_partition_taps = preset.fast_partition_taps;
            this.partitioned.min_partition_taps = preset.min_partition_taps;
            this.partitioned.max_partitions = preset.max_partitions;
            this.partitioned.tail_fft_multiple = preset.tail_fft_multiple;
        },

        buildPartitionedPayload() {
            return {
                enabled: this.partitioned.enabled,
                fast_partition_taps: this.partitioned.fast_partition_taps,
                min_partition_taps: this.partitioned.min_partition_taps,
                max_partitions: this.partitioned.max_partitions,
                tail_fft_multiple: this.partitioned.tail_fft_multiple,
            };
        },

        detectPartitionPreset(settings) {
            const target = {
                fast_partition_taps: settings.fast_partition_taps,
                min_partition_taps: settings.min_partition_taps,
                max_partitions: settings.max_partitions,
                tail_fft_multiple: settings.tail_fft_multiple,
            };

            for (const [name, preset] of Object.entries(this.partitionedPresets)) {
                if (
                    preset.fast_partition_taps === target.fast_partition_taps &&
                    preset.min_partition_taps === target.min_partition_taps &&
                    preset.max_partitions === target.max_partitions &&
                    preset.tail_fft_multiple === target.tail_fft_multiple
                ) {
                    return name;
                }
            }
            return 'custom';
        },

        formatNumber(value, fractionDigits = 0) {
            if (value === null || value === undefined) return this.messages.na;
            const num = Number(value);
            if (!Number.isFinite(num)) return this.messages.na;
            return num.toLocaleString(undefined, {
                minimumFractionDigits: fractionDigits,
                maximumFractionDigits: fractionDigits,
            });
        },

        formatWithUnit(value, unit = '', fractionDigits = 0) {
            const base = this.formatNumber(value, fractionDigits);
            if (base === this.messages.na || !unit) return base;
            return `${base} ${unit}`;
        },

        switchLanguage(target) {
            if (target === this.currentLang) return;
            const url = new URL(window.location.href);
            url.searchParams.set('lang', target);
            window.location.href = url.toString();
        },
    };
}
</script>
{% endblock %}
