{% extends "base.html" %}
{% import "components/buttons.html" as buttons %}
{% import "components/card_panel.html" as panels %}
{% import "components/status_card.html" as status_card %}

{% block title %}{{ t.get('nav.system') }} - {{ t.get('app.title') }}{% endblock %}

{% block content %}
<div x-data="systemPage()" x-init="init()">
    <div class="page-header">
        <h1 class="page-title">{{ t.get('nav.system') }}</h1>
        <p class="page-subtitle">{{ t.get('system.subtitle') }}</p>
    </div>

    {% call panels.card_panel(t.get('system.language.title')) %}
        <div class="card-row wrap">
            <div class="stack">
                <div class="muted">{{ t.get('system.language.description') }}</div>
            </div>
            {{ buttons.btn_primary(t.get('system.language.english'), icon='üá∫üá∏', click="switchLanguage('en')", extra_class='btn-secondary', attrs=':class="{ active: currentLang === &quot;en&quot; }" :aria-pressed="currentLang === &quot;en&quot;"') }}
            {{ buttons.btn_primary(t.get('system.language.japanese'), icon='üáØüáµ', click="switchLanguage('ja')", extra_class='btn-secondary', attrs=':class="{ active: currentLang === &quot;ja&quot; }" :aria-pressed="currentLang === &quot;ja&quot;"') }}
        </div>
    {% endcall %}

    <div class="section">
        <h2 class="section-title">{{ t.get('system.health.title') }}</h2>
        <div class="card-grid">
            {% set status_icon = "‚öôÔ∏è" %}
            {% set status_title = t.get('system.health.daemon') %}
            {% set status_class = "health.daemon_running ? 'status-ok' : 'status-error'" %}
            {% set status_text = "health.daemon_running ? '" ~ t.get('system.daemon.running') ~ "' : '" ~ t.get('system.daemon.stopped') ~ "'" %}
            {% include 'components/status_card.html' %}

            {% set status_icon = "üéöÔ∏è" %}
            {% set status_title = t.get('system.health.input_rate') %}
            {% set status_class = "health.input_rate > 0 ? 'status-ok' : 'status-off'" %}
            {% set status_text = "health.input_rate ? `${health.input_rate} Hz` : '" ~ t.get('system.health.na') ~ "'" %}
            {% include 'components/status_card.html' %}

            {% set status_icon = "üéõÔ∏è" %}
            {% set status_title = t.get('system.health.output_rate') %}
            {% set status_class = "health.output_rate > 0 ? 'status-ok' : 'status-off'" %}
            {% set status_text = "health.output_rate ? `${health.output_rate} Hz` : '" ~ t.get('system.health.na') ~ "'" %}
            {% include 'components/status_card.html' %}
        </div>
    </div>

    {% call panels.card_panel(t.get('system.daemon.title')) %}
        <div class="card-row wrap">
            {{ buttons.btn_primary(t.get('system.daemon.restart'), icon='üîÑ', click='restartDaemon()', disabled='actionInProgress') }}
        </div>
    {% endcall %}

    {% call panels.card_panel(t.get('system.delimiter.title')) %}
        <div class="card-row wrap">
            {% set toggle_id = "delimiter-toggle" %}
            {% set toggle_label = t.get('system.delimiter.toggle') %}
            {% set toggle_desc = t.get('system.delimiter.desc') %}
            {% set alpine_model = "delimiter.enabled" %}
            {% set alpine_click = "toggleDelimiter()" %}
            {% set alpine_disabled = "delimiter.loading || actionInProgress || !health.daemon_running || !delimiter.backendAvailable" %}
            {% include 'components/toggle_switch.html' %}
            {{ buttons.btn_primary(t.get('system.delimiter.refresh'), icon='üîÑ', click='fetchDelimiter()', disabled='delimiter.loading', extra_class='btn-secondary') }}
        </div>

        <div class="grid-3">
            <div class="stack">
                <div class="muted">{{ t.get('system.delimiter.state') }}</div>
                <div class="mono" x-text="delimiterStatusLabel()"></div>
                <div class="muted small" x-text="delimiter.backendValid ? '{{ t.get('system.delimiter.backend_valid') }}' : '{{ t.get('system.delimiter.backend_invalid') }}'"></div>
            </div>
            <div class="stack">
                <div class="muted">{{ t.get('system.delimiter.mode') }}</div>
                <div class="mono" x-text="delimiter.mode"></div>
                <div class="muted small">{{ t.get('system.delimiter.target_mode') }} <span class="mono" x-text="delimiter.target_mode"></span></div>
            </div>
            <div class="stack">
                <div class="muted">{{ t.get('system.delimiter.fallback') }}</div>
                <div class="mono" x-text="delimiter.fallback_reason"></div>
                <div class="muted small" x-show="delimiter.bypass_locked">{{ t.get('system.delimiter.locked') }}</div>
            </div>
        </div>

        <div class="grid-3">
            <div class="stack">
                <div class="muted">{{ t.get('system.delimiter.queue') }}</div>
                <div class="mono" x-text="formatQueueSeconds()"></div>
                <div class="muted small" x-text="`${delimiter.queue_samples} {{ t.get('system.delimiter.queue_samples') }}`"></div>
            </div>
            <div class="stack">
                <div class="muted">{{ t.get('system.delimiter.last_inference') }}</div>
                <div class="mono" x-text="formatInferenceMs()"></div>
            </div>
            <div class="stack">
                <div class="muted">{{ t.get('system.delimiter.detail') }}</div>
                <div class="mono" x-text="delimiter.detail || '{{ t.get('system.delimiter.no_detail') }}'"></div>
            </div>
        </div>

        <div class="alert alert-warning" x-show="!delimiter.backendAvailable">
            <span x-text="delimiter.backendHint"></span>
        </div>
        <div class="alert alert-warning" x-show="delimiter.error">
            <span x-text="delimiter.error"></span>
        </div>
    {% endcall %}

    {% call panels.card_panel(t.get('system.dac.title')) %}
        <div class="card-row wrap">
            <div class="stack">
                <div class="muted">{{ t.get('system.dac.current') }}</div>
                <div class="mono" x-text="dac.runtime?.active_device || '{{ t.get('system.dac.no_devices') }}'"></div>
            </div>
            <div class="stack">
                <div class="muted">{{ t.get('system.dac.sample_rate') }}</div>
                <div class="mono" x-text="dac.runtime?.output_rate || 'N/A'"></div>
            </div>
            {{ buttons.btn_primary(t.get('system.dac.rescan'), icon='üîç', click='rescanDac()', disabled='actionInProgress || dac.loading', extra_class='btn-secondary') }}
        </div>

        <div class="form-grid" x-show="dac.devices.length > 0">
            {% set form_label = t.get('system.dac.select') %}
            {% set form_input_type = "select" %}
            {% set form_input_model = "dac.selected" %}
            {% set form_input_disabled = "actionInProgress || dac.loading" %}
            {% set form_on_change = "dac.userSelected = true" %}
            {% set form_select_options = '<template x-for="device in dac.devices" :key="device.id"><option :value="device.id" x-text="device.name ? `${device.name} (${device.id})` : device.id"></option></template>' %}
            {% include 'components/form_group.html' %}
        </div>
        <div class="btn-row" x-show="dac.devices.length > 0">
            {{ buttons.btn_primary(t.get('system.dac.select'), icon='üéß', click='selectDac(dac.selected)', disabled='actionInProgress || !dac.selected || dac.runtime?.active_device === dac.selected', extra_class='btn-secondary') }}
        </div>
        <template x-if="dac.devices.length === 0">
            {% set info_message = t.get('system.dac.no_devices') %}
            {% include 'components/info_text.html' %}
        </template>
    {% endcall %}

    {% call panels.card_panel(t.get('system.partitioned.title')) %}
        <div class="card-row wrap">
            {% set toggle_id = "partitioned-toggle" %}
            {% set toggle_label = t.get('system.partitioned.enable') %}
            {% set toggle_desc = t.get('system.partitioned.desc') %}
            {% set alpine_model = "partitioned.enabled" %}
            {% set alpine_click = "togglePartitioned()" %}
            {% include 'components/toggle_switch.html' %}
        </div>

        <div class="form-grid" x-show="partitioned.enabled">
            {% set form_label = t.get('system.partitioned.fast_taps') %}
            {% set form_input_type = "number" %}
            {% set form_input_model = "partitioned.fast_partition_taps" %}
            {% set form_input_attrs = 'min="4096" max="131072" step="4096"' %}
            {% include 'components/form_group.html' %}

            {% set form_label = t.get('system.partitioned.min_taps') %}
            {% set form_input_type = "number" %}
            {% set form_input_model = "partitioned.min_partition_taps" %}
            {% set form_input_attrs = 'min="4096" max="131072" step="4096"' %}
            {% include 'components/form_group.html' %}

            {% set form_label = t.get('system.partitioned.max_partitions') %}
            {% set form_input_type = "number" %}
            {% set form_input_model = "partitioned.max_partitions" %}
            {% set form_input_attrs = 'min="1" max="16" step="1"' %}
            {% include 'components/form_group.html' %}

            {% set form_label = t.get('system.partitioned.tail_multiple') %}
            {% set form_input_type = "number" %}
            {% set form_input_model = "partitioned.tail_fft_multiple" %}
            {% set form_input_attrs = 'min="2" max="16" step="1"' %}
            {% include 'components/form_group.html' %}
        </div>

        <div class="btn-row" x-show="partitioned.enabled">
            {{ buttons.btn_primary(t.get('system.partitioned.save'), icon='üíæ', click='savePartitioned()', disabled='partitioned.loading || actionInProgress') }}
            {{ buttons.btn_primary(t.get('system.partitioned.reset_defaults'), icon='‚Ü∫', click='resetPartitioned()', disabled='partitioned.loading || actionInProgress', extra_class='btn-secondary') }}
        </div>
    {% endcall %}

    {% call panels.card_panel(t.get('system.buffer.title')) %}
        <div class="grid-2">
            <div class="stack">
                <div class="muted">{{ t.get('system.buffer.size') }}</div>
                <div class="mono" x-text="config.bufferSize ?? 'N/A'"></div>
            </div>
            <div class="stack">
                <div class="muted">{{ t.get('system.buffer.period') }}</div>
                <div class="mono" x-text="config.periodSize ?? 'N/A'"></div>
            </div>
        </div>
        <div class="grid-2">
            <div class="stack">
                <div class="muted">{{ t.get('system.gain.gain') }}</div>
                <div class="mono" x-text="config.gain ?? 'N/A'"></div>
            </div>
            <div class="stack">
                <div class="muted">{{ t.get('system.gain.headroom') }}</div>
                <div class="mono" x-text="config.headroomTarget ?? 'N/A'"></div>
            </div>
        </div>
    {% endcall %}

    {% call panels.card_panel(t.get('system.debug.title')) %}
        <div class="grid-2">
            <div class="stack">
                <div class="muted">{{ t.get('system.debug.xrun_count') }}</div>
                <div class="mono" x-text="debug.xrun_count ?? 0"></div>
            </div>
            <div class="stack">
                <div class="muted">{{ t.get('system.debug.buffer_capacity') }}</div>
                <div class="mono" x-text="debug.buffer_capacity_frames ?? 0"></div>
            </div>
        </div>
        <div class="grid-2">
            <div class="stack">
                <div class="muted">{{ t.get('system.debug.dropped_frames') }}</div>
                <div class="mono" x-text="debug.dropped_frames ?? 0"></div>
            </div>
            <div class="stack">
                <div class="muted">{{ t.get('system.debug.rendered_silence_blocks') }}</div>
                <div class="mono" x-text="debug.rendered_silence_blocks ?? 0"></div>
            </div>
        </div>
        <div class="grid-2">
            <div class="stack">
                <div class="muted">{{ t.get('system.debug.rendered_silence_frames') }}</div>
                <div class="mono" x-text="debug.rendered_silence_frames ?? 0"></div>
            </div>
            <div class="stack">
                <div class="muted">{{ t.get('system.debug.alsa_buffer_size_config') }}</div>
                <div class="mono" x-text="debug.alsa_buffer_size_config ?? 0"></div>
            </div>
        </div>
        <div class="grid-2">
            <div class="stack">
                <div class="muted">{{ t.get('system.debug.alsa_period_size_config') }}</div>
                <div class="mono" x-text="debug.alsa_period_size_config ?? 0"></div>
            </div>
        </div>
    {% endcall %}
</div>
{% endblock %}

{% block extra_scripts %}
<script>
function systemPage() {
    return {
        health: { daemon_running: false, input_rate: 0, output_rate: 0 },
        dac: { devices: [], runtime: null, loading: false, selected: '', userSelected: false },
        currentLang: "{{ lang }}",
        delimiter: {
            loading: false,
            enabled: false,
            backendAvailable: false,
            backendValid: false,
            warmup: false,
            mode: 'unknown',
            target_mode: 'unknown',
            fallback_reason: 'unknown',
            bypass_locked: false,
            queue_seconds: 0,
            queue_samples: 0,
            last_inference_ms: 0,
            detail: '',
            error: '',
            backendHint: "{{ t.get('system.delimiter.backend_hint') }}",
        },
        partitioned: {
            enabled: false,
            fast_partition_taps: 32768,
            min_partition_taps: 32768,
            max_partitions: 4,
            tail_fft_multiple: 2,
            loading: false,
        },
        config: { bufferSize: null, periodSize: null, gain: null, headroomTarget: null },
        debug: {
            xrun_count: 0,
            buffer_capacity_frames: 0,
            dropped_frames: 0,
            rendered_silence_blocks: 0,
            rendered_silence_frames: 0,
            alsa_buffer_size_config: 0,
            alsa_period_size_config: 0,
        },
        actionInProgress: false,

        init() {
            this.refreshAll();
            setInterval(() => {
                this.fetchStatus();
                this.fetchDacState();
                this.fetchDelimiter();
            }, 5000);
        },

        async refreshAll() {
            await Promise.all([
                this.fetchStatus(),
                this.fetchDacDevices(),
                this.fetchDacState(),
                this.fetchDelimiter(),
                this.fetchPartitioned(),
            ]);
        },

        async fetchStatus() {
            try {
                const res = await fetch('/status');
                if (!res.ok) return;
                const data = await res.json();
                this.health.daemon_running = data.daemon_running;
                this.health.input_rate = data.input_rate || 0;
                this.health.output_rate = data.output_rate || 0;
                const settings = data.settings;
                if (settings) {
                    this.config.bufferSize = settings.buffer_size;
                    this.config.periodSize = settings.period_size;
                    this.config.gain = settings.gain;
                    this.config.headroomTarget = settings.headroom_target;
                }
                this.debug.xrun_count = data.xrun_count ?? 0;
                this.debug.buffer_capacity_frames = data.buffer_capacity_frames ?? 0;
                this.debug.dropped_frames = data.dropped_frames ?? 0;
                this.debug.rendered_silence_blocks = data.rendered_silence_blocks ?? 0;
                this.debug.rendered_silence_frames = data.rendered_silence_frames ?? 0;
                this.debug.alsa_buffer_size_config = data.alsa_buffer_size_config ?? 0;
                this.debug.alsa_period_size_config = data.alsa_period_size_config ?? 0;
            } catch (err) {
                console.error('status fetch failed', err);
            }
        },

        applyDelimiterStatus(status) {
            const safe = status && typeof status === 'object' ? status : {};
            this.delimiter.enabled = Boolean(safe.enabled);
            this.delimiter.backendAvailable = Boolean(safe.backend_available);
            this.delimiter.backendValid = Boolean(safe.backend_valid);
            this.delimiter.warmup = Boolean(safe.warmup);
            this.delimiter.mode = safe.mode || 'unknown';
            this.delimiter.target_mode = safe.target_mode || 'unknown';
            this.delimiter.fallback_reason = safe.fallback_reason || 'unknown';
            this.delimiter.bypass_locked = Boolean(safe.bypass_locked);
            this.delimiter.queue_seconds = Number(safe.queue_seconds || 0);
            this.delimiter.queue_samples = Number(safe.queue_samples || 0);
            this.delimiter.last_inference_ms = Number(safe.last_inference_ms || 0);
            this.delimiter.detail = safe.detail || '';
        },

        async fetchDelimiter() {
            this.delimiter.loading = true;
            this.delimiter.error = '';
            try {
                const res = await fetch('/delimiter/status');
                const data = await res.json().catch(() => ({}));
                if (!res.ok) {
                    throw new Error(data.detail || data.message || 'Failed to fetch De-limiter');
                }
                this.applyDelimiterStatus(data);
            } catch (err) {
                this.delimiter.error = err.message;
                this.delimiter.backendAvailable = false;
            } finally {
                this.delimiter.loading = false;
            }
        },

        delimiterStatusLabel() {
            if (!this.health.daemon_running) {
                return '{{ t.get("system.delimiter.status_daemon_down") }}';
            }
            if (!this.delimiter.backendAvailable) {
                return '{{ t.get("system.delimiter.status_unavailable") }}';
            }
            if (this.delimiter.bypass_locked) {
                return '{{ t.get("system.delimiter.status_locked") }}';
            }
            if (this.delimiter.enabled) {
                return this.delimiter.warmup
                    ? '{{ t.get("system.delimiter.status_warmup") }}'
                    : '{{ t.get("system.delimiter.status_on") }}';
            }
            return '{{ t.get("system.delimiter.status_off") }}';
        },

        formatQueueSeconds() {
            const seconds = Number(this.delimiter.queue_seconds || 0);
            return `${seconds.toFixed(2)} s`;
        },

        formatInferenceMs() {
            const ms = Number(this.delimiter.last_inference_ms || 0);
            return `${ms.toFixed(2)} ms`;
        },

        async toggleDelimiter() {
            if (this.delimiter.loading || this.actionInProgress) return;
            const enable = !this.delimiter.enabled;
            this.delimiter.loading = true;
            this.actionInProgress = true;
            try {
                const res = await fetch(enable ? '/delimiter/enable' : '/delimiter/disable', {
                    method: 'POST',
                });
                const data = await res.json().catch(() => ({}));
                if (!res.ok) {
                    throw new Error(data.detail || data.message || 'Toggle failed');
                }
                const status = data.status || data;
                this.applyDelimiterStatus(status);
                showToast(
                    enable
                        ? '{{ t.get("system.delimiter.toast_enabled") }}'
                        : '{{ t.get("system.delimiter.toast_disabled") }}',
                    'success'
                );
            } catch (err) {
                this.delimiter.error = err.message;
                showToast(err.message, 'error');
            } finally {
                this.delimiter.loading = false;
                this.actionInProgress = false;
            }
        },

        async restartDaemon() {
            if (!confirm('{{ t.get("system.confirm.restart") }}')) return;
            this.actionInProgress = true;
            try {
                const res = await fetch('/daemon/restart', { method: 'POST' });
                const data = await res.json().catch(() => ({}));
                if (!res.ok) throw new Error(data.detail || data.message || 'restart failed');
                showToast(data.message || '{{ t.get("system.toast.restart_ok") }}', 'success');
                await this.fetchStatus();
            } catch (err) {
                showToast(err.message, 'error');
            } finally {
                this.actionInProgress = false;
            }
        },

        async fetchDacDevices() {
            this.dac.loading = true;
            try {
                const res = await fetch('/dac/devices');
                const data = await res.json();
                this.dac.devices = data.devices || [];
                // Keep selection stable (prefer active device -> previous selection -> first item)
                const active = this.dac.runtime?.active_device;
                const ids = new Set(this.dac.devices.map(d => d.id));
                if (active && ids.has(active)) {
                    this.dac.selected = active;
                } else if (this.dac.selected && ids.has(this.dac.selected)) {
                    // keep
                } else {
                    this.dac.selected = this.dac.devices[0]?.id || '';
                }
            } catch (err) {
                console.error('dac devices failed', err);
            } finally {
                this.dac.loading = false;
            }
        },

        async fetchDacState() {
            try {
                const res = await fetch('/dac/state');
                if (!res.ok) return;
                this.dac.runtime = await res.json();
                if (
                    this.dac.runtime?.active_device &&
                    (!this.dac.userSelected || !this.dac.selected)
                ) {
                    this.dac.selected = this.dac.runtime.active_device;
                }
            } catch (err) {
                console.error('dac state failed', err);
            }
        },

        async rescanDac() {
            this.actionInProgress = true;
            try {
                await fetch('/dac/rescan', { method: 'POST' });
                await this.fetchDacDevices();
                await this.fetchDacState();
            } catch (err) {
                console.error('dac rescan failed', err);
            } finally {
                this.actionInProgress = false;
            }
        },

        async selectDac(id) {
            if (!id) return;
            if (this.dac.runtime?.active_device === id) return;
            if (!confirm('{{ t.get("system.confirm.switch_dac") }}')) return;
            this.actionInProgress = true;
            try {
                const res = await fetch('/dac/select', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ device: id, persist: true }),
                });
                const data = await res.json().catch(() => ({}));
                if (!res.ok) throw new Error(data.detail || data.message || 'failed');
                showToast(data.message || '{{ t.get("system.toast.dac_ok") }}', 'success');
                await this.fetchDacState();
            } catch (err) {
                showToast(err.message, 'error');
            } finally {
                this.actionInProgress = false;
            }
        },

        async fetchPartitioned() {
            try {
                const res = await fetch('/partitioned-convolution');
                if (!res.ok) return;
                const data = await res.json();
                this.partitioned.enabled = data.enabled;
                this.partitioned.fast_partition_taps = data.fast_partition_taps;
                this.partitioned.min_partition_taps = data.min_partition_taps;
                this.partitioned.max_partitions = data.max_partitions;
                this.partitioned.tail_fft_multiple = data.tail_fft_multiple;
            } catch (err) {
                console.error('partitioned fetch failed', err);
            }
        },

        togglePartitioned() {
            this.partitioned.enabled = !this.partitioned.enabled;
        },

        async savePartitioned() {
            this.partitioned.loading = true;
            this.actionInProgress = true;
            try {
                const res = await fetch('/partitioned-convolution', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(this.partitioned),
                });
                const data = await res.json().catch(() => ({}));
                if (!res.ok || data.success === false) {
                    throw new Error(data.detail || data.message || 'failed');
                }
                showToast(data.message || '{{ t.get("system.partitioned.save") }}', 'success');
                await this.fetchPartitioned();
            } catch (err) {
                showToast(err.message, 'error');
            } finally {
                this.partitioned.loading = false;
                this.actionInProgress = false;
            }
        },

        resetPartitioned() {
            this.partitioned.fast_partition_taps = 32768;
            this.partitioned.min_partition_taps = 32768;
            this.partitioned.max_partitions = 4;
            this.partitioned.tail_fft_multiple = 2;
            showToast('{{ t.get("system.partitioned.reset_defaults") }}', 'info');
        },

        switchLanguage(target) {
            if (target === this.currentLang) return;
            const url = new URL(window.location.href);
            url.searchParams.set('lang', target);
            window.location.href = url.toString();
        },
    };
}
</script>
{% endblock %}
