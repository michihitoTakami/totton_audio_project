{% extends "base.html" %}
{% import "components/buttons.html" as buttons %}
{% import "components/card_panel.html" as panels %}
{% import "components/status_card.html" as status_card %}
{% import "components/slider_input.html" as sliders %}

{% block title %}{{ t.get('nav.pi') }} - {{ t.get('app.title') }}{% endblock %}

{% block content %}
<div x-data="piSettingsPage()" x-init="init()">
    <div class="page-header">
        <h1 class="page-title">{{ t.get('nav.pi') }}</h1>
        <p class="page-subtitle">{{ t.get('pi.subtitle') }}</p>
    </div>

    <div class="section">
        <h2 class="section-title">{{ t.get('pi.status.title') }}</h2>
        <div class="card-grid">
            {% set status_icon = "üß†" %}
            {% set status_title = t.get('pi.status.running') %}
            {% set status_class = "piStatus.running ? 'status-ok' : 'status-error'" %}
            {% set status_text = "piStatus.running ? '" ~ t.get('pi.status.running_on') ~ "' : '" ~ t.get('pi.status.running_off') ~ "'" %}
            {% set status_subtext = "formatTimestamp(piStatus.updated_at_unix_ms)" %}
            {% include 'components/status_card.html' %}

            {% set status_icon = "üéõÔ∏è" %}
            {% set status_title = t.get('pi.status.sample_rate') %}
            {% set status_class = "piStatus.sample_rate > 0 ? 'status-ok' : 'status-off'" %}
            {% set status_text = "piStatus.sample_rate ? `${piStatus.sample_rate} Hz` : '" ~ t.get('system.health.na') ~ "'" %}
            {% set status_subtext = "piStatus.mode || '" ~ t.get('pi.status.mode_na') ~ "'" %}
            {% include 'components/status_card.html' %}

            {% set status_icon = "üßæ" %}
            {% set status_title = t.get('pi.status.format') %}
            {% set status_class = "piStatus.format ? 'status-ok' : 'status-off'" %}
            {% set status_text = "piStatus.format || '" ~ t.get('system.health.na') ~ "'" %}
            {% set status_subtext = "piStatus.channels ? `${piStatus.channels} ch` : '" ~ t.get('system.health.na') ~ "'" %}
            {% include 'components/status_card.html' %}

            {% set status_icon = "‚ö†Ô∏è" %}
            {% set status_title = t.get('pi.status.last_error') %}
            {% set status_class = "piStatus.last_error ? 'status-error' : 'status-ok'" %}
            {% set status_text = "piStatus.last_error || '" ~ t.get('pi.status.no_error') ~ "'" %}
            {% set status_subtext = "piStatus.xruns ? `XRuns: ${piStatus.xruns}` : '" ~ t.get('pi.status.xruns_none') ~ "'" %}
            {% include 'components/status_card.html' %}
        </div>
    </div>

    <div class="section">
        <h2 class="section-title">{{ t.get('pi.peer.title') }}</h2>
        <div class="card-grid">
            {% set status_icon = "üì°" %}
            {% set status_title = t.get('pi.peer.running') %}
            {% set status_class = "peerStatus.running ? 'status-ok' : 'status-off'" %}
            {% set status_text = "peerStatus.running ? '" ~ t.get('pi.peer.running_on') ~ "' : '" ~ t.get('pi.peer.running_off') ~ "'" %}
            {% set status_subtext = "formatTimestamp(peerStatus.updated_at_unix_ms)" %}
            {% include 'components/status_card.html' %}

            {% set status_icon = "üéöÔ∏è" %}
            {% set status_title = t.get('pi.peer.sample_rate') %}
            {% set status_class = "peerStatus.sample_rate > 0 ? 'status-ok' : 'status-off'" %}
            {% set status_text = "peerStatus.sample_rate ? `${peerStatus.sample_rate} Hz` : '" ~ t.get('system.health.na') ~ "'" %}
            {% set status_subtext = "peerStatus.mode || '" ~ t.get('pi.status.mode_na') ~ "'" %}
            {% include 'components/status_card.html' %}

            {% set status_icon = "üîâ" %}
            {% set status_title = t.get('pi.peer.format') %}
            {% set status_class = "peerStatus.format ? 'status-ok' : 'status-off'" %}
            {% set status_text = "peerStatus.format || '" ~ t.get('system.health.na') ~ "'" %}
            {% set status_subtext = "peerStatus.channels ? `${peerStatus.channels} ch` : '" ~ t.get('system.health.na') ~ "'" %}
            {% include 'components/status_card.html' %}
        </div>
        {% set info_message = t.get('pi.peer.note') %}
        {% set info_show = "peerStatus.updated_at_unix_ms === 0" %}
        {% include 'components/info_text.html' %}
    </div>

    {% call panels.card_panel(t.get('pi.config.title')) %}
        <div class="card-row wrap">
            <div class="stack">
                <div class="muted">{{ t.get('pi.config.description') }}</div>
            </div>
            <div class="btn-row">
                {{ buttons.btn_primary(t.get('pi.config.refresh'), icon='üîÑ', click='fetchConfig()', disabled='actionInProgress || config.loading', extra_class='btn-secondary') }}
                {{ buttons.btn_primary(t.get('pi.config.restart'), icon='‚èª', click='restartBridge()', disabled='actionInProgress') }}
            </div>
        </div>

        <div class="form-grid">
            {% set form_label = t.get('pi.config.device_preset') %}
            {% set form_input_type = "select" %}
            {% set form_input_model = "devicePreset" %}
            {% set form_on_change = "applyDevicePreset()" %}
            {% set form_select_options = '<template x-for=\"preset in devicePresets\" :key=\"preset.id\"><option :value=\"preset.id\" x-text=\"preset.label\"></option></template>' %}
            {% include 'components/form_group.html' %}

            {% set selector_label = t.get('pi.config.latency') %}
            {% set alpine_model = "latencyProfile" %}
            {% set alpine_click = "setLatencyProfile" %}
            {% set alpine_disabled = "actionInProgress || config.loading" %}
            {% set sizes = ['low', 'medium', 'safe'] %}
            {% set size_labels = {
                'low': t.get('pi.config.latency.low_short'),
                'medium': t.get('pi.config.latency.medium_short'),
                'safe': t.get('pi.config.latency.safe_short'),
            } %}
            {% set size_descriptions = {
                'low': t.get('pi.config.latency.low_desc'),
                'medium': t.get('pi.config.latency.medium_desc'),
                'safe': t.get('pi.config.latency.safe_desc'),
            } %}
            {% include 'components/size_selector.html' %}

            {% set info_message = t.get('pi.config.latency.custom_note') %}
            {% set info_show = "latencyProfile === 'custom'" %}
            {% include 'components/info_text.html' %}

            {% set form_label = t.get('pi.config.capture_device') %}
            {% set form_input_model = "config.capture_device" %}
            {% set form_input_disabled = "true" %}
            {% include 'components/form_group.html' %}

            {% set form_label = t.get('pi.config.playback_device') %}
            {% set form_input_model = "config.playback_device" %}
            {% set form_input_disabled = "true" %}
            {% include 'components/form_group.html' %}
        </div>

        <div class="card-row wrap">
            {% set toggle_id = "pi-advanced" %}
            {% set toggle_label = t.get('pi.config.advanced') %}
            {% set toggle_desc = t.get('pi.config.advanced_desc') %}
            {% set alpine_model = "advancedMode" %}
            {% set alpine_click = "toggleAdvancedMode()" %}
            {% include 'components/toggle_switch.html' %}
        </div>

        <div x-show="advancedMode">
            <div class="form-grid">
                {% set form_label = t.get('pi.config.capture_device') %}
                {% set form_input_model = "config.capture_device" %}
                {% set form_input_disabled = "devicePreset !== 'custom'" %}
                {% include 'components/form_group.html' %}

                {% set form_label = t.get('pi.config.playback_device') %}
                {% set form_input_model = "config.playback_device" %}
                {% set form_input_disabled = "devicePreset !== 'custom'" %}
                {% include 'components/form_group.html' %}

                {% set form_label = t.get('pi.config.channels') %}
                {% set form_input_type = "number" %}
                {% set form_input_model = "config.channels" %}
                {% include 'components/form_group.html' %}

                {% set form_label = t.get('pi.config.fallback_rate') %}
                {% set form_input_type = "number" %}
                {% set form_input_model = "config.fallback_rate" %}
                {% include 'components/form_group.html' %}

                {% set form_label = t.get('pi.config.preferred_format') %}
                {% set form_input_model = "config.preferred_format" %}
                {% include 'components/form_group.html' %}
            </div>

            <div class="form-grid">
                {% set form_label = t.get('pi.config.buffer_time_us') %}
                {% set form_input_type = "number" %}
                {% set form_input_model = "config.alsa_buffer_time_us" %}
                {% include 'components/form_group.html' %}

                {% set form_label = t.get('pi.config.latency_time_us') %}
                {% set form_input_type = "number" %}
                {% set form_input_model = "config.alsa_latency_time_us" %}
                {% include 'components/form_group.html' %}

                {% set form_label = t.get('pi.config.queue_time_ns') %}
                {% set form_input_type = "number" %}
                {% set form_input_model = "config.queue_time_ns" %}
                {% include 'components/form_group.html' %}
            </div>

            <div class="card-row wrap">
                {% set toggle_id = "pi-passthrough" %}
                {% set toggle_label = t.get('pi.config.passthrough') %}
                {% set toggle_desc = t.get('pi.config.passthrough_desc') %}
                {% set alpine_model = "config.passthrough" %}
                {% set alpine_click = "togglePassthrough()" %}
                {% include 'components/toggle_switch.html' %}

                {% set toggle_id = "pi-keep-silence" %}
                {% set toggle_label = t.get('pi.config.keep_silence') %}
                {% set toggle_desc = t.get('pi.config.keep_silence_desc') %}
                {% set alpine_model = "config.keep_silence_when_no_capture" %}
                {% set alpine_click = "toggleKeepSilence()" %}
                {% include 'components/toggle_switch.html' %}
            </div>

            <div class="form-grid">
                {{ sliders.slider_input(
                    label=t.get('pi.config.fade_ms'),
                    min=0,
                    max=200,
                    step=5,
                    model="config.fade_ms"
                ) }}

                {% set form_label = t.get('pi.config.poll_interval_sec') %}
                {% set form_input_type = "number" %}
                {% set form_input_model = "config.poll_interval_sec" %}
                {% include 'components/form_group.html' %}

                {% set form_label = t.get('pi.config.restart_backoff_sec') %}
                {% set form_input_type = "number" %}
                {% set form_input_model = "config.restart_backoff_sec" %}
                {% include 'components/form_group.html' %}
            </div>

            <div class="form-grid">
                {% set form_label = t.get('pi.config.status_report_url') %}
                {% set form_input_model = "config.status_report_url" %}
                {% set form_input_placeholder = "http://192.168.55.1/i2s/peer-status" %}
                {% include 'components/form_group.html' %}

                {% set form_label = t.get('pi.config.status_report_timeout_ms') %}
                {% set form_input_type = "number" %}
                {% set form_input_model = "config.status_report_timeout_ms" %}
                {% include 'components/form_group.html' %}

                {% set form_label = t.get('pi.config.status_report_min_interval_sec') %}
                {% set form_input_type = "number" %}
                {% set form_input_model = "config.status_report_min_interval_sec" %}
                {% include 'components/form_group.html' %}
            </div>

            <div class="form-grid">
                {% set form_label = t.get('pi.config.control_endpoint') %}
                {% set form_input_model = "config.control_endpoint" %}
                {% include 'components/form_group.html' %}

                {% set form_label = t.get('pi.config.control_peer') %}
                {% set form_input_model = "config.control_peer" %}
                {% include 'components/form_group.html' %}

                {% set form_label = t.get('pi.config.control_require_peer') %}
                {% set form_input_type = "select" %}
                {% set form_input_model = "config.control_require_peer" %}
                {% set form_select_options %}
                <option :value="true">{{ t.get('pi.config.control_require_peer_on') }}</option>
                <option :value="false">{{ t.get('pi.config.control_require_peer_off') }}</option>
                {% endset %}
                {% include 'components/form_group.html' %}

                {% set form_label = t.get('pi.config.control_poll_interval_sec') %}
                {% set form_input_type = "number" %}
                {% set form_input_model = "config.control_poll_interval_sec" %}
                {% include 'components/form_group.html' %}

                {% set form_label = t.get('pi.config.control_timeout_ms') %}
                {% set form_input_type = "number" %}
                {% set form_input_model = "config.control_timeout_ms" %}
                {% include 'components/form_group.html' %}
            </div>
        </div>

        <div class="btn-row">
            {{ buttons.btn_primary(t.get('pi.config.apply'), icon='üíæ', click='applyConfig()', disabled='actionInProgress || config.loading') }}
        </div>
    {% endcall %}

    {% call panels.card_panel(t.get('pi.notes.title')) %}
        <div class="config-notes">
            <div class="config-note">{{ t.get('pi.notes.device_preset') }}</div>
            <div class="config-note">{{ t.get('pi.notes.latency_preset') }}</div>
            <div class="config-note">{{ t.get('pi.notes.capture_playback') }}</div>
            <div class="config-note">{{ t.get('pi.notes.channels') }}</div>
            <div class="config-note">{{ t.get('pi.notes.fallback_rate') }}</div>
            <div class="config-note">{{ t.get('pi.notes.preferred_format') }}</div>
            <div class="config-note">{{ t.get('pi.notes.passthrough') }}</div>
            <div class="config-note">{{ t.get('pi.notes.buffer_time') }}</div>
            <div class="config-note">{{ t.get('pi.notes.latency_time') }}</div>
            <div class="config-note">{{ t.get('pi.notes.queue_time') }}</div>
            <div class="config-note">{{ t.get('pi.notes.fade_ms') }}</div>
            <div class="config-note">{{ t.get('pi.notes.poll_interval') }}</div>
            <div class="config-note">{{ t.get('pi.notes.restart_backoff') }}</div>
            <div class="config-note">{{ t.get('pi.notes.keep_silence') }}</div>
            <div class="config-note">{{ t.get('pi.notes.status_report_url') }}</div>
            <div class="config-note">{{ t.get('pi.notes.status_report_timeout') }}</div>
            <div class="config-note">{{ t.get('pi.notes.status_report_min_interval') }}</div>
            <div class="config-note">{{ t.get('pi.notes.control_endpoint') }}</div>
            <div class="config-note">{{ t.get('pi.notes.control_peer') }}</div>
            <div class="config-note">{{ t.get('pi.notes.control_require_peer') }}</div>
            <div class="config-note">{{ t.get('pi.notes.control_poll_interval') }}</div>
            <div class="config-note">{{ t.get('pi.notes.control_timeout') }}</div>
        </div>
    {% endcall %}
</div>
{% endblock %}

{% block extra_scripts %}
<script>
function piSettingsPage() {
    return {
        piStatus: {
            running: false,
            mode: '',
            sample_rate: 0,
            format: '',
            channels: 0,
            xruns: 0,
            last_error: null,
            last_error_at_unix_ms: null,
            uptime_sec: 0,
            updated_at_unix_ms: 0,
        },
        peerStatus: {
            running: false,
            mode: '',
            sample_rate: 0,
            format: '',
            channels: 0,
            updated_at_unix_ms: 0,
        },
        config: {
            capture_device: '',
            playback_device: '',
            channels: 2,
            fallback_rate: 44100,
            preferred_format: 'S32_LE',
            passthrough: true,
            alsa_buffer_time_us: 200000,
            alsa_latency_time_us: 20000,
            queue_time_ns: 100000000,
            fade_ms: 80,
            poll_interval_sec: 1.0,
            restart_backoff_sec: 0.5,
            keep_silence_when_no_capture: true,
            status_report_url: '',
            status_report_timeout_ms: 300,
            status_report_min_interval_sec: 1.0,
            control_endpoint: '',
            control_peer: '',
            control_require_peer: false,
            control_poll_interval_sec: 1.0,
            control_timeout_ms: 2000,
            loading: false,
        },
        devicePreset: 'default',
        latencyProfile: 'medium',
        advancedMode: false,
        actionInProgress: false,
        piApiLastError: null,
        latencyProfiles: {
            // NOTE: ÂÆüÈöõ„ÅÆ‰ΩìÊÑüÈÅÖÂª∂„ÅØ„Éá„Éê„Ç§„Çπ/Áí∞Â¢É„Å´‰æùÂ≠ò„Åô„Çã„Åü„ÇÅ "ÁõÆÂÆâ"„ÄÇ
            // ALSA buffer/latency „Å® queue „ÇíÂêå„ÅòÊØîÁéá„Åß„Çπ„Ç±„Éº„É´„Åï„Åõ„ÄÅÊìç‰ΩúÊÑü„ÇíÊèÉ„Åà„Çã„ÄÇ
            low: {
                alsa_buffer_time_us: 100000,
                alsa_latency_time_us: 10000,
                queue_time_ns: 50000000,
            },
            medium: {
                alsa_buffer_time_us: 200000,
                alsa_latency_time_us: 20000,
                queue_time_ns: 100000000,
            },
            safe: {
                alsa_buffer_time_us: 400000,
                alsa_latency_time_us: 40000,
                queue_time_ns: 200000000,
            },
        },
        devicePresets: [
            {
                id: 'default',
                label: '{{ t.get("pi.config.device_preset.default") }}',
                capture_device: 'hw:3,0',
                playback_device: 'hw:2,0',
            },
            {
                id: 'custom',
                label: '{{ t.get("pi.config.device_preset.custom") }}',
                capture_device: '',
                playback_device: '',
            },
        ],

        init() {
            // Ë©≥Á¥∞„É¢„Éº„Éâ„ÅßÊâãÂãïÁ∑®ÈõÜ„Åï„Çå„ÅüÂ†¥Âêà„ÅØ ‚Äúcustom‚Äù Ë°®Á§∫„Å´ËøΩÂæì„Åï„Åõ„Çã
            this.$watch('config.alsa_buffer_time_us', () => {
                this.latencyProfile = this.detectLatencyProfile();
            });
            this.$watch('config.alsa_latency_time_us', () => {
                this.latencyProfile = this.detectLatencyProfile();
            });
            this.$watch('config.queue_time_ns', () => {
                this.latencyProfile = this.detectLatencyProfile();
            });

            this.refreshAll();
            setInterval(() => {
                this.fetchStatus();
                this.fetchPeerStatus();
            }, 5000);
        },

        async refreshAll() {
            await Promise.all([
                this.fetchStatus(),
                this.fetchPeerStatus(),
                this.fetchConfig(),
            ]);
        },

        async fetchStatus() {
            try {
                const res = await fetch('/pi/status');
                if (!res.ok) {
                    const msg = await this.extractApiError(res, 'Pi status fetch failed');
                    this.setPiApiError(msg);
                    return;
                }
                const data = await res.json();
                this.piStatus = {
                    ...this.piStatus,
                    ...data,
                };
                this.clearPiApiError();
            } catch (err) {
                console.error('pi status fetch failed', err);
                this.setPiApiError(String(err));
            }
        },

        async fetchPeerStatus() {
            try {
                const res = await fetch('/i2s/peer-status');
                if (!res.ok) return;
                const data = await res.json();
                this.peerStatus = {
                    ...this.peerStatus,
                    ...data,
                };
            } catch (err) {
                console.error('peer status fetch failed', err);
            }
        },

        async fetchConfig() {
            this.config.loading = true;
            try {
                const res = await fetch('/pi/config');
                if (!res.ok) {
                    const msg = await this.extractApiError(res, 'failed to fetch config');
                    this.setPiApiError(msg);
                    throw new Error(msg);
                }
                const data = await res.json();
                this.config = {
                    ...this.config,
                    ...data,
                    loading: false,
                };
                this.devicePreset = this.detectDevicePreset();
                this.latencyProfile = this.detectLatencyProfile();
                this.clearPiApiError();
            } catch (err) {
                console.error('config fetch failed', err);
                this.config.loading = false;
            }
        },

        detectDevicePreset() {
            const matches = this.devicePresets.find((preset) => {
                if (preset.id === 'custom') return false;
                return (
                    String(this.config.capture_device || '') === preset.capture_device &&
                    String(this.config.playback_device || '') === preset.playback_device
                );
            });
            return matches ? matches.id : 'custom';
        },

        detectLatencyProfile() {
            const equals = (a, b) => Number(a) === Number(b);
            for (const [id, profile] of Object.entries(this.latencyProfiles)) {
                if (
                    equals(this.config.alsa_buffer_time_us, profile.alsa_buffer_time_us) &&
                    equals(this.config.alsa_latency_time_us, profile.alsa_latency_time_us) &&
                    equals(this.config.queue_time_ns, profile.queue_time_ns)
                ) {
                    return id;
                }
            }
            return 'custom';
        },

        applyDevicePreset() {
            const preset = this.devicePresets.find(
                (item) => item.id === this.devicePreset
            );
            if (!preset || preset.id === 'custom') return;
            this.config.capture_device = preset.capture_device;
            this.config.playback_device = preset.playback_device;
        },

        setLatencyProfile(profileId) {
            const profile = this.latencyProfiles[String(profileId)];
            if (!profile) {
                this.latencyProfile = 'custom';
                return;
            }
            this.latencyProfile = String(profileId);
            this.config.alsa_buffer_time_us = profile.alsa_buffer_time_us;
            this.config.alsa_latency_time_us = profile.alsa_latency_time_us;
            this.config.queue_time_ns = profile.queue_time_ns;
        },

        togglePassthrough() {
            this.config.passthrough = !this.config.passthrough;
        },

        toggleKeepSilence() {
            this.config.keep_silence_when_no_capture = !this.config.keep_silence_when_no_capture;
        },

        toggleAdvancedMode() {
            this.advancedMode = !this.advancedMode;
        },

        formatTimestamp(unixMs) {
            if (!unixMs) return '{{ t.get("pi.status.not_available") }}';
            try {
                return new Date(unixMs).toLocaleString();
            } catch (err) {
                return '{{ t.get("pi.status.not_available") }}';
            }
        },

        async applyConfig() {
            if (this.actionInProgress) return;
            this.actionInProgress = true;
            try {
                const payload = this.buildPayload();
                const res = await fetch('/pi/config?apply=true', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                });
                if (!res.ok) {
                    const msg = await this.extractApiError(res, 'apply failed');
                    this.setPiApiError(msg);
                    throw new Error(msg);
                }
                const data = await res.json();
                this.config = { ...this.config, ...data };
                this.devicePreset = this.detectDevicePreset();
                this.latencyProfile = this.detectLatencyProfile();
                showToast('{{ t.get("pi.toast.apply_ok") }}', 'success');
                this.clearPiApiError();
            } catch (err) {
                console.error('apply config failed', err);
                showToast('{{ t.get("pi.toast.apply_error") }}', 'error');
            } finally {
                this.actionInProgress = false;
            }
        },

        async restartBridge() {
            if (this.actionInProgress) return;
            this.actionInProgress = true;
            try {
                const res = await fetch('/pi/actions/restart', { method: 'POST' });
                if (!res.ok) {
                    const msg = await this.extractApiError(res, 'restart failed');
                    this.setPiApiError(msg);
                    throw new Error(msg);
                }
                await res.json();
                showToast('{{ t.get("pi.toast.restart_ok") }}', 'success');
                setTimeout(() => this.fetchStatus(), 1500);
                this.clearPiApiError();
            } catch (err) {
                console.error('restart failed', err);
                showToast('{{ t.get("pi.toast.restart_error") }}', 'error');
            } finally {
                this.actionInProgress = false;
            }
        },

        setPiApiError(message) {
            const msg = String(message || '').trim() || 'Pi API error';
            if (this.piApiLastError === msg) return;
            this.piApiLastError = msg;
            // ÈÄ£Á∂ö„Éù„Éº„É™„É≥„Ç∞„Åß„Éà„Éº„Çπ„Éà„ÅåÈÄ£Â∞Ñ„Åï„Çå„Å™„ÅÑ„Çà„ÅÜ„ÄÅÂ§âÂåñÊôÇ„ÅÆ„ÅøÂá∫„Åô
            showToast(msg, 'error', 5000);
            // ÁîªÈù¢‰∏ä„Å´„ÇÇ„ÄåÊúÄÂæå„Å´Ëµ∑„Åç„ÅüÂïèÈ°å„Äç„ÇíÊÆã„ÅôÔºàstatus card „Å´Ë°®Á§∫„Åï„Çå„ÇãÔºâ
            this.piStatus = {
                ...this.piStatus,
                running: false,
                last_error: msg,
                updated_at_unix_ms: Date.now(),
            };
        },

        clearPiApiError() {
            this.piApiLastError = null;
        },

        async extractApiError(res, fallbackMessage) {
            try {
                const contentType = res.headers.get('content-type') || '';
                if (contentType.includes('application/json')) {
                    const data = await res.json();
                    if (data && typeof data.detail === 'string' && data.detail.trim().length) {
                        return data.detail.trim();
                    }
                }
                const text = await res.text();
                if (text && text.trim().length) return text.trim();
            } catch (err) {
                // ignore parsing error
            }
            return `${fallbackMessage} (${res.status})`;
        },

        buildPayload() {
            const toInt = (value, fallback = 0) => {
                const n = Number(value);
                return Number.isFinite(n) ? Math.trunc(n) : fallback;
            };
            const toFloat = (value, fallback = 0) => {
                const n = Number(value);
                return Number.isFinite(n) ? n : fallback;
            };
            const toOptionalString = (value) => {
                if (value === null || value === undefined) return null;
                const trimmed = String(value).trim();
                return trimmed.length ? trimmed : null;
            };
            const preset = this.devicePresets.find(
                (item) => item.id === this.devicePreset
            );
            const usePreset = preset && preset.id !== 'custom';
            return {
                capture_device: usePreset
                    ? preset.capture_device
                    : String(this.config.capture_device || '').trim(),
                playback_device: usePreset
                    ? preset.playback_device
                    : String(this.config.playback_device || '').trim(),
                channels: toInt(this.config.channels, 2),
                fallback_rate: toInt(this.config.fallback_rate, 44100),
                preferred_format: String(this.config.preferred_format || '').trim(),
                passthrough: Boolean(this.config.passthrough),
                alsa_buffer_time_us: toInt(this.config.alsa_buffer_time_us, 200000),
                alsa_latency_time_us: toInt(this.config.alsa_latency_time_us, 20000),
                queue_time_ns: toInt(this.config.queue_time_ns, 100000000),
                fade_ms: toInt(this.config.fade_ms, 80),
                poll_interval_sec: toFloat(this.config.poll_interval_sec, 1.0),
                restart_backoff_sec: toFloat(this.config.restart_backoff_sec, 0.5),
                keep_silence_when_no_capture: Boolean(this.config.keep_silence_when_no_capture),
                status_report_url: toOptionalString(this.config.status_report_url),
                status_report_timeout_ms: toInt(this.config.status_report_timeout_ms, 300),
                status_report_min_interval_sec: toFloat(
                    this.config.status_report_min_interval_sec,
                    1.0
                ),
                control_endpoint: toOptionalString(this.config.control_endpoint),
                control_peer: toOptionalString(this.config.control_peer),
                control_require_peer: Boolean(this.config.control_require_peer),
                control_poll_interval_sec: toFloat(this.config.control_poll_interval_sec, 1.0),
                control_timeout_ms: toInt(this.config.control_timeout_ms, 2000),
            };
        },
    };
}
</script>
{% endblock %}
