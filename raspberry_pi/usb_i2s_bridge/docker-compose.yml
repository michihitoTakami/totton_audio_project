services:
  usb-i2s-bridge:
    build:
      context: ../..
      dockerfile: raspberry_pi/usb_i2s_bridge/Dockerfile
    container_name: rpi-usb-i2s-bridge
    network_mode: "host"
    cap_add:
      - "SYS_NICE"
    ulimits:
      rtprio: 95
      memlock: -1
    # NOTE(#950): 60100/60101 の ZeroMQ 制御プレーンはデフォルト無効化。
    # 必要なら config.env で USB_I2S_CONTROL_ENDPOINT を設定し、ports も適宜開けること。
    devices:
      - "/dev/snd:/dev/snd"
    group_add:
      - "audio"
    environment:
      # 設定は /var/lib/usb-i2s-bridge/config.env に集約
      USB_I2S_CONFIG_PATH: /var/lib/usb-i2s-bridge/config.env
      # NOTE(#1079): Pi → Jetson の状態送信をデフォルト有効化（必要なら config.env 側で上書き/無効化）
      # 典型: USB直結構成の Jetson は 192.168.55.1
      USB_I2S_STATUS_REPORT_URL: ${USB_I2S_STATUS_REPORT_URL:-http://192.168.55.1/i2s/peer-status}
    restart: always
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    volumes:
      - usb-i2s-bridge-run:/var/run/usb-i2s-bridge
      - usb-i2s-bridge-config:/var/lib/usb-i2s-bridge

  raspi-control-api:
    build:
      context: ../..
      dockerfile: raspberry_pi/control_api/Dockerfile
    container_name: rpi-control-api
    network_mode: "host"
    depends_on:
      - usb-i2s-bridge
    environment:
      RPI_CONTROL_BIND_INTERFACE: ${RPI_CONTROL_BIND_INTERFACE:-usb0}
      RPI_CONTROL_BIND_HOST: ${RPI_CONTROL_BIND_HOST:-}
      RPI_CONTROL_BIND_SUBNET: ${RPI_CONTROL_BIND_SUBNET:-192.168.55.0/24}
      RPI_CONTROL_PORT: ${RPI_CONTROL_PORT:-8081}
      RPI_CONTROL_CONFIG_PATH: /var/lib/usb-i2s-bridge/config.env
      RPI_CONTROL_STATUS_PATH: /var/run/usb-i2s-bridge/status.json
      RPI_CONTROL_RESTART_MODE: docker
      RPI_CONTROL_DOCKER_CONTAINER: rpi-usb-i2s-bridge
    volumes:
      - usb-i2s-bridge-run:/var/run/usb-i2s-bridge:ro
      - usb-i2s-bridge-config:/var/lib/usb-i2s-bridge
      - /var/run/docker.sock:/var/run/docker.sock
    restart: always
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
volumes:
  usb-i2s-bridge-run:
  usb-i2s-bridge-config:
